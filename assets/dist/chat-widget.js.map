{
  "version": 3,
  "sources": ["../src/chat-widget/config.js", "../src/chat-widget/avatars.js", "../src/chat-widget/main.js"],
  "sourcesContent": ["// Shared config/constants for the chat widget bundle.\r\nexport const config = window.humataConfig || {};\r\n\r\nexport const STORAGE_KEY = 'humata_chat_history';\r\nexport const CONVERSATION_KEY = 'humata_conversation_id';\r\nexport const THEME_KEY = 'humata_theme_preference';\r\nexport const TURNSTILE_VERIFIED_KEY = 'humata_turnstile_verified';\r\n\r\n\r\n", "import { config } from './config.js';\r\n\r\n// Default SVG icons for avatars.\r\nconst DEFAULT_USER_AVATAR_SVG =\r\n  '<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.5\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2\"></path><circle cx=\"12\" cy=\"7\" r=\"4\"></circle></svg>';\r\n\r\nconst DEFAULT_BOT_AVATAR_SVG =\r\n  '<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.5\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M12 8V4H8\"></path><rect width=\"16\" height=\"12\" x=\"4\" y=\"8\" rx=\"2\"></rect><path d=\"M2 14h2\"></path><path d=\"M20 14h2\"></path><path d=\"M15 13v2\"></path><path d=\"M9 13v2\"></path></svg>';\r\n\r\n/**\r\n * Set avatar content for a message avatar element.\r\n *\r\n * @param {HTMLElement} avatarDiv - The avatar container element.\r\n * @param {string} type - 'user' or 'bot'.\r\n */\r\nexport function setAvatarContent(avatarDiv, type) {\r\n  const avatarUrl = type === 'user' ? config.userAvatarUrl : config.botAvatarUrl;\r\n\r\n  if (avatarUrl && avatarUrl.length > 0) {\r\n    // Custom image avatar\r\n    const img = document.createElement('img');\r\n    img.src = avatarUrl;\r\n    img.alt = type === 'user' ? 'User' : 'Bot';\r\n    img.className = 'humata-avatar-img';\r\n    avatarDiv.innerHTML = '';\r\n    avatarDiv.appendChild(img);\r\n  } else {\r\n    // Default SVG icon\r\n    avatarDiv.innerHTML = type === 'user' ? DEFAULT_USER_AVATAR_SVG : DEFAULT_BOT_AVATAR_SVG;\r\n  }\r\n}\r\n\r\n\r\n", "/**\r\n * Humata Chat Widget\r\n *\r\n * Frontend JavaScript for the chat interface.\r\n *\r\n * @package Humata_Chatbot\r\n * @since 1.0.0\r\n */\r\n\r\nimport { config, STORAGE_KEY, CONVERSATION_KEY, THEME_KEY, TURNSTILE_VERIFIED_KEY } from './config.js';\r\nimport { setAvatarContent } from './avatars.js';\r\n\r\n(function() {\r\n    'use strict';\r\n\r\n    // DOM Elements\r\n    let elements = {};\r\n\r\n    // State\r\n    let isLoading = false;\r\n    let conversationId = null;\r\n    let activeEdit = null;\r\n    let maxPromptChars = 3000;\r\n    let isEmbedded = false;\r\n    let turnstileToken = null;\r\n    let turnstileWidgetId = null;\r\n    let turnstileReady = false;\r\n    let turnstilePendingCallback = null;\r\n\r\n    /**\r\n     * Initialize the chat widget.\r\n     */\r\n    function init() {\r\n        // Cache DOM elements\r\n        elements = {\r\n            container: document.getElementById('humata-chat-container'),\r\n            messages: document.getElementById('humata-chat-messages'),\r\n            input: document.getElementById('humata-chat-input'),\r\n            inputCounter: document.getElementById('humata-chat-input-counter'),\r\n            sendButton: document.getElementById('humata-send-button'),\r\n            scrollToggle: document.getElementById('humata-scroll-toggle'),\r\n            exportPdfButton: document.getElementById('humata-export-pdf'),\r\n            clearButton: document.getElementById('humata-clear-chat'),\r\n            themeToggle: document.getElementById('humata-theme-toggle'),\r\n            welcomeMessage: document.getElementById('humata-welcome-message')\r\n        };\r\n\r\n        if (!elements.container || !elements.messages || !elements.input) {\r\n            return;\r\n        }\r\n\r\n        // Detect embedded mode\r\n        isEmbedded = elements.container.classList.contains('humata-chat-embedded');\r\n\r\n        maxPromptChars = getMaxPromptChars();\r\n        if (elements.input && maxPromptChars > 0) {\r\n            elements.input.maxLength = maxPromptChars;\r\n        }\r\n\r\n        // Initialize theme\r\n        initTheme();\r\n\r\n        // Initialize Turnstile if enabled\r\n        initTurnstile();\r\n\r\n        if (elements.welcomeMessage) {\r\n            ensureCopyButton(elements.welcomeMessage.querySelector('.humata-message-content'));\r\n        }\r\n\r\n        // Load conversation history\r\n        loadHistory();\r\n\r\n        // Bind events\r\n        bindEvents();\r\n\r\n        handleInput();\r\n\r\n        // Initialize scroll toggle state\r\n        updateScrollToggleState();\r\n\r\n        // Focus input\r\n        if (elements.input) {\r\n            elements.input.focus();\r\n        }\r\n\r\n        updateScrollToggleState();\r\n    }\r\n\r\n    /**\r\n     * Initialize theme based on settings.\r\n     */\r\n    function initTheme() {\r\n        const savedTheme = localStorage.getItem(THEME_KEY);\r\n        const configTheme = config.theme || 'auto';\r\n\r\n        let theme = savedTheme || configTheme;\r\n\r\n        if (theme === 'auto') {\r\n            theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';\r\n        }\r\n\r\n        applyTheme(theme);\r\n\r\n        // Listen for system theme changes\r\n        if (configTheme === 'auto' && !savedTheme) {\r\n            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {\r\n                if (!localStorage.getItem(THEME_KEY)) {\r\n                    applyTheme(e.matches ? 'dark' : 'light');\r\n                }\r\n            });\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Apply theme to the document.\r\n     *\r\n     * @param {string} theme - Theme name ('dark' or 'light').\r\n     */\r\n    function applyTheme(theme) {\r\n        const html = document.documentElement;\r\n        const body = document.body;\r\n\r\n        html.classList.remove('humata-theme-dark', 'humata-theme-light');\r\n        body.classList.remove('humata-theme-dark', 'humata-theme-light');\r\n\r\n        if (theme === 'dark') {\r\n            html.classList.add('humata-theme-dark');\r\n            body.classList.add('humata-theme-dark');\r\n        } else {\r\n            html.classList.add('humata-theme-light');\r\n            body.classList.add('humata-theme-light');\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Toggle theme between dark and light.\r\n     */\r\n    function toggleTheme() {\r\n        const isDark = document.documentElement.classList.contains('humata-theme-dark');\r\n        const newTheme = isDark ? 'light' : 'dark';\r\n\r\n        localStorage.setItem(THEME_KEY, newTheme);\r\n        applyTheme(newTheme);\r\n    }\r\n\r\n    /**\r\n     * Check if Turnstile is enabled.\r\n     *\r\n     * @returns {boolean} True if Turnstile is enabled.\r\n     */\r\n    function isTurnstileEnabled() {\r\n        return config.turnstile && config.turnstile.enabled && config.turnstile.siteKey;\r\n    }\r\n\r\n    /**\r\n     * Check if user is already verified in this session.\r\n     *\r\n     * @returns {boolean} True if already verified.\r\n     */\r\n    function isTurnstileVerified() {\r\n        if (!isTurnstileEnabled()) {\r\n            return true;\r\n        }\r\n        return sessionStorage.getItem(TURNSTILE_VERIFIED_KEY) === 'true';\r\n    }\r\n\r\n    /**\r\n     * Mark Turnstile as verified in session storage.\r\n     */\r\n    function setTurnstileVerified() {\r\n        sessionStorage.setItem(TURNSTILE_VERIFIED_KEY, 'true');\r\n    }\r\n\r\n    /**\r\n     * Load Cloudflare Turnstile script.\r\n     *\r\n     * @returns {Promise} Resolves when script is loaded.\r\n     */\r\n    function loadTurnstileScript() {\r\n        return new Promise(function(resolve, reject) {\r\n            if (window.turnstile) {\r\n                turnstileReady = true;\r\n                resolve();\r\n                return;\r\n            }\r\n\r\n            const script = document.createElement('script');\r\n            script.src = 'https://challenges.cloudflare.com/turnstile/v0/api.js?onload=onTurnstileLoad';\r\n            script.async = true;\r\n            script.defer = true;\r\n\r\n            // Global callback for Turnstile script load\r\n            window.onTurnstileLoad = function() {\r\n                turnstileReady = true;\r\n                resolve();\r\n            };\r\n\r\n            script.onerror = function() {\r\n                reject(new Error('Failed to load Turnstile script'));\r\n            };\r\n\r\n            document.head.appendChild(script);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Show Turnstile widget and get verification token.\r\n     *\r\n     * @returns {Promise<string>} Resolves with the Turnstile token.\r\n     */\r\n    function getTurnstileToken() {\r\n        return new Promise(function(resolve, reject) {\r\n            // If already verified, resolve immediately\r\n            if (isTurnstileVerified()) {\r\n                resolve(null);\r\n                return;\r\n            }\r\n\r\n            // Get the container element\r\n            const container = document.getElementById('humata-turnstile-container');\r\n            if (!container) {\r\n                // No container, skip Turnstile\r\n                resolve(null);\r\n                return;\r\n            }\r\n\r\n            // Load script if not already loaded\r\n            loadTurnstileScript().then(function() {\r\n                console.log('Turnstile script loaded, preparing to render widget');\r\n\r\n                // Remove any existing widget first\r\n                if (turnstileWidgetId !== null && window.turnstile) {\r\n                    try {\r\n                        window.turnstile.remove(turnstileWidgetId);\r\n                    } catch (e) {\r\n                        // Ignore removal errors\r\n                    }\r\n                    turnstileWidgetId = null;\r\n                }\r\n\r\n                // Prepare the container - must be visible for Turnstile to work\r\n                container.innerHTML = '<div id=\"humata-turnstile-widget\"></div>';\r\n                container.style.display = 'flex';\r\n\r\n                const widgetContainer = document.getElementById('humata-turnstile-widget');\r\n                console.log('Turnstile container visible, widget container:', widgetContainer);\r\n\r\n                // Small delay to ensure DOM is ready\r\n                setTimeout(function() {\r\n                    try {\r\n                        // Render the Turnstile widget\r\n                        turnstileWidgetId = window.turnstile.render(widgetContainer, {\r\n                            sitekey: config.turnstile.siteKey,\r\n                            appearance: config.turnstile.appearance || 'managed',\r\n                            theme: document.documentElement.classList.contains('humata-theme-dark') ? 'dark' : 'light',\r\n                            size: 'normal',\r\n                            callback: function(token) {\r\n                                turnstileToken = token;\r\n                                // Hide container after verification\r\n                                container.style.display = 'none';\r\n                                container.innerHTML = '';\r\n                                resolve(token);\r\n                            },\r\n                            'error-callback': function(errorCode) {\r\n                                console.error('Turnstile error:', errorCode);\r\n                                container.style.display = 'none';\r\n                                container.innerHTML = '';\r\n                                reject(new Error('Turnstile verification failed: ' + (errorCode || 'unknown')));\r\n                            },\r\n                            'expired-callback': function() {\r\n                                // Token expired, need to re-verify\r\n                                turnstileToken = null;\r\n                            }\r\n                        });\r\n                        \r\n                        // Check if Cloudflare rendered a visible widget (iframe)\r\n                        // If not, hide the container since verification is happening invisibly\r\n                        setTimeout(function() {\r\n                            const iframe = widgetContainer.querySelector('iframe');\r\n                            if (!iframe) {\r\n                                // No visible widget - Cloudflare is verifying invisibly\r\n                                // Hide the empty container to avoid showing a blank box\r\n                                container.style.display = 'none';\r\n                            }\r\n                        }, 100);\r\n                    } catch (renderError) {\r\n                        console.error('Turnstile render error:', renderError);\r\n                        container.style.display = 'none';\r\n                        container.innerHTML = '';\r\n                        reject(renderError);\r\n                    }\r\n                }, 50);\r\n            }).catch(function(error) {\r\n                console.error('Turnstile script load error:', error);\r\n                reject(error);\r\n            });\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Initialize Turnstile if enabled.\r\n     */\r\n    function initTurnstile() {\r\n        if (!isTurnstileEnabled()) {\r\n            return;\r\n        }\r\n\r\n        // Preload the script for faster first-message experience\r\n        loadTurnstileScript().catch(function() {\r\n            // Silent fail - will retry when needed\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Bind event listeners.\r\n     */\r\n    function bindEvents() {\r\n        // Send button click\r\n        if (elements.sendButton) {\r\n            elements.sendButton.addEventListener('click', handleSend);\r\n        }\r\n\r\n        // Input keydown\r\n        if (elements.input) {\r\n            elements.input.addEventListener('keydown', handleKeyDown);\r\n            elements.input.addEventListener('input', handleInput);\r\n        }\r\n\r\n        // Scroll toggle\r\n        if (elements.scrollToggle) {\r\n            elements.scrollToggle.addEventListener('click', handleScrollToggle);\r\n        }\r\n\r\n        // Scroll event for scroll toggle state\r\n        if (isEmbedded && elements.messages) {\r\n            elements.messages.addEventListener('scroll', updateScrollToggleState, { passive: true });\r\n        } else {\r\n            window.addEventListener('scroll', updateScrollToggleState, { passive: true });\r\n        }\r\n\r\n        // Messages click handler\r\n        if (elements.messages) {\r\n            elements.messages.addEventListener('click', handleMessagesClick);\r\n        }\r\n\r\n        // Clear button\r\n        if (elements.clearButton) {\r\n            elements.clearButton.addEventListener('click', handleClear);\r\n        }\r\n\r\n        if (elements.exportPdfButton) {\r\n            elements.exportPdfButton.addEventListener('click', handleExportPdf);\r\n        }\r\n\r\n        // Theme toggle\r\n        if (elements.themeToggle) {\r\n            elements.themeToggle.addEventListener('click', toggleTheme);\r\n        }\r\n\r\n        // Trigger page modals\r\n        initTriggerPageModals();\r\n    }\r\n\r\n    /**\r\n     * Initialize trigger page modal behavior.\r\n     */\r\n    function initTriggerPageModals() {\r\n        // Open modal from trigger links\r\n        document.addEventListener('click', function(e) {\r\n            const trigger = e.target.closest('[data-humata-page-modal]');\r\n            if (!trigger) {\r\n                return;\r\n            }\r\n            e.preventDefault();\r\n            const modalIndex = trigger.getAttribute('data-humata-page-modal');\r\n            const modal = document.getElementById('humata-page-modal-' + modalIndex);\r\n            if (modal) {\r\n                openPageModal(modal, trigger);\r\n            }\r\n        });\r\n\r\n        // Close modal on overlay or close button click\r\n        document.addEventListener('click', function(e) {\r\n            const closeTarget = e.target.closest('[data-humata-page-close-modal]');\r\n            if (!closeTarget) {\r\n                return;\r\n            }\r\n            const modal = closeTarget.closest('.humata-help-modal');\r\n            if (modal) {\r\n                e.preventDefault();\r\n                closePageModal(modal);\r\n            }\r\n        });\r\n\r\n        // ESC closes modal\r\n        document.addEventListener('keydown', function(e) {\r\n            if (e.key !== 'Escape') {\r\n                return;\r\n            }\r\n            const openModal = document.querySelector('.humata-help-modal.is-open');\r\n            if (openModal) {\r\n                e.preventDefault();\r\n                closePageModal(openModal);\r\n            }\r\n        });\r\n    }\r\n\r\n    let pageModalLastFocused = null;\r\n\r\n    /**\r\n     * Open a trigger page modal.\r\n     *\r\n     * @param {HTMLElement} modal - Modal element.\r\n     * @param {HTMLElement} triggerEl - Trigger element.\r\n     */\r\n    function openPageModal(modal, triggerEl) {\r\n        pageModalLastFocused = triggerEl || document.activeElement;\r\n\r\n        modal.hidden = false;\r\n        modal.classList.add('is-open');\r\n        modal.setAttribute('aria-hidden', 'false');\r\n\r\n        document.documentElement.classList.add('humata-help-modal-open');\r\n        document.body.classList.add('humata-help-modal-open');\r\n\r\n        const closeBtn = modal.querySelector('.humata-help-modal__close');\r\n        if (closeBtn) {\r\n            try {\r\n                closeBtn.focus({ preventScroll: true });\r\n            } catch (err) {\r\n                closeBtn.focus();\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Close a trigger page modal.\r\n     *\r\n     * @param {HTMLElement} modal - Modal element.\r\n     */\r\n    function closePageModal(modal) {\r\n        modal.classList.remove('is-open');\r\n        modal.setAttribute('aria-hidden', 'true');\r\n        modal.hidden = true;\r\n\r\n        document.documentElement.classList.remove('humata-help-modal-open');\r\n        document.body.classList.remove('humata-help-modal-open');\r\n\r\n        if (pageModalLastFocused && typeof pageModalLastFocused.focus === 'function') {\r\n            try {\r\n                pageModalLastFocused.focus({ preventScroll: true });\r\n            } catch (err) {\r\n                pageModalLastFocused.focus();\r\n            }\r\n        }\r\n        pageModalLastFocused = null;\r\n    }\r\n\r\n    function getMaxPromptChars() {\r\n        const fromConfig = parseInt(config.maxPromptChars, 10);\r\n        if (Number.isFinite(fromConfig) && fromConfig > 0) {\r\n            return fromConfig;\r\n        }\r\n\r\n        if (elements.input) {\r\n            const fromAttr = parseInt(elements.input.getAttribute('maxlength'), 10);\r\n            if (Number.isFinite(fromAttr) && fromAttr > 0) {\r\n                return fromAttr;\r\n            }\r\n        }\r\n\r\n        return 3000;\r\n    }\r\n\r\n    function updatePromptCounter() {\r\n        if (!elements.input || !elements.inputCounter) {\r\n            return;\r\n        }\r\n\r\n        const current = (elements.input.value || '').length;\r\n        const max = maxPromptChars || 3000;\r\n\r\n        elements.inputCounter.textContent = current + '/' + max;\r\n        elements.inputCounter.classList.toggle('humata-input-counter-over', current > max);\r\n    }\r\n\r\n    function handleMessagesClick(event) {\r\n        const regenerateButton = event.target.closest('.humata-regenerate-button');\r\n        if (regenerateButton) {\r\n            const messageEl = regenerateButton.closest('.humata-message');\r\n            if (!messageEl || isLoading || activeEdit) {\r\n                return;\r\n            }\r\n\r\n            let userMessageEl = messageEl.previousElementSibling;\r\n            while (userMessageEl && !userMessageEl.classList.contains('humata-message-user')) {\r\n                userMessageEl = userMessageEl.previousElementSibling;\r\n            }\r\n\r\n            if (!userMessageEl) {\r\n                return;\r\n            }\r\n\r\n            const contentEl = userMessageEl.querySelector('.humata-message-content');\r\n            if (!contentEl) {\r\n                return;\r\n            }\r\n\r\n            const text = getMessagePlainText(contentEl);\r\n            if (!text) {\r\n                return;\r\n            }\r\n\r\n            const history = getChatHistoryForRequestBefore(userMessageEl);\r\n            truncateConversationAfter(userMessageEl);\r\n            saveHistory();\r\n            sendMessage(text, history);\r\n            return;\r\n        }\r\n\r\n        const copyButton = event.target.closest('.humata-copy-button');\r\n        if (copyButton) {\r\n            const messageEl = copyButton.closest('.humata-message');\r\n            if (!messageEl) {\r\n                return;\r\n            }\r\n\r\n            const contentEl = messageEl.querySelector('.humata-message-content');\r\n            if (!contentEl) {\r\n                return;\r\n            }\r\n\r\n            const payload = getMessageClipboardPayload(contentEl);\r\n            if (!payload || (!payload.text && !payload.html)) {\r\n                return;\r\n            }\r\n\r\n            copyToClipboard(payload)\r\n                .then(function() {\r\n                    indicateCopySuccess(copyButton);\r\n                })\r\n                .catch(function() {\r\n                    indicateCopyFailure(copyButton);\r\n                });\r\n            return;\r\n        }\r\n\r\n        const editButton = event.target.closest('.humata-edit-button');\r\n        if (editButton) {\r\n            const messageEl = editButton.closest('.humata-message');\r\n            if (!messageEl || isLoading) {\r\n                return;\r\n            }\r\n            startEditMessage(messageEl);\r\n            return;\r\n        }\r\n\r\n        const cancelButton = event.target.closest('.humata-edit-cancel');\r\n        if (cancelButton) {\r\n            cancelActiveEdit();\r\n            return;\r\n        }\r\n\r\n        const saveButton = event.target.closest('.humata-edit-save');\r\n        if (saveButton) {\r\n            saveActiveEdit();\r\n        }\r\n    }\r\n\r\n    function setComposerEnabled(enabled) {\r\n        if (!elements.input) {\r\n            return;\r\n        }\r\n\r\n        elements.input.disabled = !enabled;\r\n\r\n        if (elements.sendButton) {\r\n            if (!enabled) {\r\n                elements.sendButton.disabled = true;\r\n            } else {\r\n                const value = elements.input.value || '';\r\n                elements.sendButton.disabled = !value.trim() || value.length > maxPromptChars;\r\n            }\r\n        }\r\n\r\n        updatePromptCounter();\r\n    }\r\n\r\n    function startEditMessage(messageEl) {\r\n        if (!messageEl || !messageEl.classList.contains('humata-message-user')) {\r\n            return;\r\n        }\r\n\r\n        const contentEl = messageEl.querySelector('.humata-message-content');\r\n        if (!contentEl) {\r\n            return;\r\n        }\r\n\r\n        if (activeEdit && activeEdit.messageEl === messageEl) {\r\n            return;\r\n        }\r\n\r\n        cancelActiveEdit();\r\n\r\n        const originalText = getMessagePlainText(contentEl);\r\n        if (!originalText) {\r\n            return;\r\n        }\r\n\r\n        activeEdit = {\r\n            messageEl: messageEl,\r\n            contentEl: contentEl,\r\n            originalText: originalText\r\n        };\r\n\r\n        messageEl.classList.add('humata-message-editing');\r\n        contentEl.classList.add('humata-message-content-editing');\r\n        contentEl.textContent = '';\r\n\r\n        const textarea = document.createElement('textarea');\r\n        textarea.className = 'humata-edit-textarea';\r\n        textarea.value = originalText;\r\n        textarea.rows = 1;\r\n        textarea.maxLength = maxPromptChars;\r\n\r\n        const actions = document.createElement('div');\r\n        actions.className = 'humata-edit-actions';\r\n\r\n        const cancelButton = document.createElement('button');\r\n        cancelButton.type = 'button';\r\n        cancelButton.className = 'humata-edit-cancel';\r\n        cancelButton.innerHTML = getXIconSvg();\r\n        cancelButton.setAttribute('title', config.i18n?.cancel || 'Cancel');\r\n        cancelButton.setAttribute('aria-label', config.i18n?.cancel || 'Cancel');\r\n\r\n        const saveButton = document.createElement('button');\r\n        saveButton.type = 'button';\r\n        saveButton.className = 'humata-edit-save';\r\n        saveButton.innerHTML = getCheckIconSvg();\r\n        saveButton.setAttribute('title', config.i18n?.save || 'Save');\r\n        saveButton.setAttribute('aria-label', config.i18n?.save || 'Save');\r\n\r\n        actions.appendChild(cancelButton);\r\n        actions.appendChild(saveButton);\r\n\r\n        contentEl.appendChild(textarea);\r\n        contentEl.appendChild(actions);\r\n\r\n        setComposerEnabled(false);\r\n\r\n        textarea.addEventListener('input', function() {\r\n            autoResizeEditTextarea(textarea);\r\n        });\r\n\r\n        textarea.addEventListener('keydown', function(e) {\r\n            if (e.key === 'Escape') {\r\n                e.preventDefault();\r\n                cancelActiveEdit();\r\n                return;\r\n            }\r\n            if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {\r\n                e.preventDefault();\r\n                saveActiveEdit();\r\n            }\r\n        });\r\n\r\n        requestAnimationFrame(function() {\r\n            autoResizeEditTextarea(textarea);\r\n            textarea.focus();\r\n            textarea.setSelectionRange(textarea.value.length, textarea.value.length);\r\n        });\r\n    }\r\n\r\n    function autoResizeEditTextarea(textarea) {\r\n        if (!textarea) {\r\n            return;\r\n        }\r\n\r\n        textarea.style.height = 'auto';\r\n\r\n        const lineHeight = parseInt(getComputedStyle(textarea).lineHeight) || 24;\r\n        const maxHeight = lineHeight * 8;\r\n        const newHeight = Math.min(textarea.scrollHeight, maxHeight);\r\n\r\n        textarea.style.height = newHeight + 'px';\r\n\r\n        updatePromptCounter();\r\n    }\r\n\r\n    function cancelActiveEdit() {\r\n        if (!activeEdit) {\r\n            return;\r\n        }\r\n\r\n        restoreUserMessageContent(activeEdit.messageEl, activeEdit.originalText);\r\n        activeEdit = null;\r\n        setComposerEnabled(true);\r\n\r\n        if (elements.input) {\r\n            elements.input.focus();\r\n        }\r\n    }\r\n\r\n    function saveActiveEdit() {\r\n        if (!activeEdit || isLoading) {\r\n            return;\r\n        }\r\n\r\n        const textarea = activeEdit.contentEl.querySelector('.humata-edit-textarea');\r\n        if (!textarea) {\r\n            cancelActiveEdit();\r\n            return;\r\n        }\r\n\r\n        const rawText = textarea.value;\r\n        const newText = rawText.trim();\r\n        if (!newText) {\r\n            textarea.focus();\r\n            return;\r\n        }\r\n\r\n        if (rawText.length > maxPromptChars) {\r\n            const errorMessage = config.i18n?.errorPromptTooLong || ('Message is too long. Maximum is ' + maxPromptChars + ' characters.');\r\n            addMessage(errorMessage, 'bot', true);\r\n            textarea.focus();\r\n            return;\r\n        }\r\n\r\n        const history = getChatHistoryForRequestBefore(activeEdit.messageEl);\r\n\r\n        restoreUserMessageContent(activeEdit.messageEl, newText);\r\n        truncateConversationAfter(activeEdit.messageEl);\r\n        activeEdit = null;\r\n        setComposerEnabled(true);\r\n        saveHistory();\r\n        sendMessage(newText, history);\r\n    }\r\n\r\n    function restoreUserMessageContent(messageEl, text) {\r\n        if (!messageEl) {\r\n            return;\r\n        }\r\n\r\n        const contentEl = messageEl.querySelector('.humata-message-content');\r\n        if (!contentEl) {\r\n            return;\r\n        }\r\n\r\n        messageEl.classList.remove('humata-message-editing');\r\n        contentEl.classList.remove('humata-message-content-editing');\r\n        contentEl.innerHTML = '';\r\n        contentEl.textContent = text;\r\n\r\n        ensureCopyButton(contentEl);\r\n        ensureEditButton(contentEl);\r\n    }\r\n\r\n    function truncateConversationAfter(messageEl) {\r\n        if (!elements.messages || !messageEl) {\r\n            return;\r\n        }\r\n\r\n        hideLoading();\r\n\r\n        let node = messageEl.nextSibling;\r\n        while (node) {\r\n            const next = node.nextSibling;\r\n            if (node.nodeType === 1) {\r\n                node.remove();\r\n            }\r\n            node = next;\r\n        }\r\n    }\r\n\r\n    function getChatHistoryForRequestBefore(messageEl) {\r\n        if (!elements.messages) {\r\n            return [];\r\n        }\r\n\r\n        const history = [];\r\n        const messageElements = elements.messages.querySelectorAll('.humata-message:not(#humata-welcome-message):not(.humata-message-loading)');\r\n\r\n        for (let i = 0; i < messageElements.length; i++) {\r\n            const el = messageElements[i];\r\n            if (el === messageEl) {\r\n                break;\r\n            }\r\n\r\n            const isUser = el.classList.contains('humata-message-user');\r\n            const isError = el.classList.contains('humata-message-error');\r\n\r\n            if (isError) {\r\n                continue;\r\n            }\r\n\r\n            const content = el.querySelector('.humata-message-content');\r\n            if (!content) {\r\n                continue;\r\n            }\r\n\r\n            const text = getMessagePlainText(content);\r\n            if (!text) {\r\n                continue;\r\n            }\r\n\r\n            history.push({\r\n                type: isUser ? 'user' : 'bot',\r\n                content: text\r\n            });\r\n        }\r\n\r\n        return history;\r\n    }\r\n\r\n    /**\r\n     * Update scroll toggle state based on current scroll position.\r\n     */\r\n    function updateScrollToggleState() {\r\n        if (!elements.scrollToggle) {\r\n            return;\r\n        }\r\n\r\n        let scrollHeight, clientHeight, scrollTop;\r\n\r\n        if (isEmbedded && elements.messages) {\r\n            scrollHeight = elements.messages.scrollHeight;\r\n            clientHeight = elements.messages.clientHeight;\r\n            scrollTop = elements.messages.scrollTop;\r\n        } else {\r\n            scrollHeight = document.documentElement.scrollHeight;\r\n            clientHeight = window.innerHeight;\r\n            scrollTop = window.scrollY || document.documentElement.scrollTop;\r\n        }\r\n\r\n        const maxScrollable = scrollHeight - clientHeight;\r\n\r\n        if (maxScrollable <= 50) {\r\n            elements.scrollToggle.style.display = 'none';\r\n            return;\r\n        }\r\n\r\n        elements.scrollToggle.style.display = '';\r\n\r\n        const distanceFromBottom = scrollHeight - (scrollTop + clientHeight);\r\n        const threshold = maxScrollable * 0.3;\r\n        const shouldScrollToTop = distanceFromBottom <= threshold;\r\n\r\n        elements.scrollToggle.classList.toggle('humata-scroll-toggle-top', shouldScrollToTop);\r\n\r\n        const labelTop = elements.scrollToggle.getAttribute('data-label-top') || 'Scroll to top';\r\n        const labelBottom = elements.scrollToggle.getAttribute('data-label-bottom') || 'Scroll to bottom';\r\n        const label = shouldScrollToTop ? labelTop : labelBottom;\r\n\r\n        elements.scrollToggle.setAttribute('title', label);\r\n        elements.scrollToggle.setAttribute('aria-label', label);\r\n    }\r\n\r\n    /**\r\n     * Handle scroll toggle click.\r\n     */\r\n    function handleScrollToggle() {\r\n        if (!elements.scrollToggle) {\r\n            return;\r\n        }\r\n\r\n        const shouldScrollToTop = elements.scrollToggle.classList.contains('humata-scroll-toggle-top');\r\n\r\n        if (isEmbedded && elements.messages) {\r\n            const targetTop = shouldScrollToTop ? 0 : elements.messages.scrollHeight;\r\n            elements.messages.scrollTo({\r\n                top: targetTop,\r\n                behavior: 'smooth'\r\n            });\r\n        } else {\r\n            const targetTop = shouldScrollToTop ? 0 : document.documentElement.scrollHeight;\r\n            window.scrollTo({\r\n                top: targetTop,\r\n                behavior: 'smooth'\r\n            });\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Handle input changes for auto-expanding textarea.\r\n     */\r\n    function handleInput() {\r\n        const textarea = elements.input;\r\n\r\n        // Reset height to auto to get the correct scrollHeight\r\n        textarea.style.height = 'auto';\r\n\r\n        // Calculate new height (max 5 rows)\r\n        const lineHeight = parseInt(getComputedStyle(textarea).lineHeight) || 24;\r\n        const maxHeight = lineHeight * 5;\r\n        const newHeight = Math.min(textarea.scrollHeight, maxHeight);\r\n\r\n        textarea.style.height = newHeight + 'px';\r\n\r\n        const tooLong = textarea.value.length > maxPromptChars;\r\n\r\n        updatePromptCounter();\r\n\r\n        // Enable/disable send button based on input\r\n        if (elements.sendButton) {\r\n            elements.sendButton.disabled = !textarea.value.trim() || tooLong;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Handle keydown events in input.\r\n     *\r\n     * @param {KeyboardEvent} event - Keyboard event.\r\n     */\r\n    function handleKeyDown(event) {\r\n        if (event.key === 'Enter' && !event.shiftKey) {\r\n            event.preventDefault();\r\n            handleSend();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Handle send button click.\r\n     */\r\n    function handleSend() {\r\n        const rawMessage = elements.input.value;\r\n        const message = rawMessage.trim();\r\n\r\n        if (!message || isLoading) {\r\n            return;\r\n        }\r\n\r\n        if (rawMessage.length > maxPromptChars) {\r\n            const errorMessage = config.i18n?.errorPromptTooLong || ('Message is too long. Maximum is ' + maxPromptChars + ' characters.');\r\n            addMessage(errorMessage, 'bot', true);\r\n            if (elements.input) {\r\n                elements.input.focus();\r\n            }\r\n            return;\r\n        }\r\n\r\n        const history = getChatHistoryForRequest();\r\n\r\n        // Store user message for intent link matching\r\n        lastUserMessageForIntents = message;\r\n\r\n        // Add user message to chat\r\n        addMessage(message, 'user');\r\n\r\n        // Clear input\r\n        elements.input.value = '';\r\n        elements.input.style.height = 'auto';\r\n        if (elements.sendButton) {\r\n            elements.sendButton.disabled = true;\r\n        }\r\n\r\n        updatePromptCounter();\r\n\r\n        // Send to API\r\n        sendMessage(message, history);\r\n    }\r\n\r\n    function getChatHistoryForRequest() {\r\n        if (!elements.messages) return [];\r\n\r\n        const history = [];\r\n        const messageElements = elements.messages.querySelectorAll('.humata-message:not(#humata-welcome-message):not(.humata-message-loading)');\r\n\r\n        messageElements.forEach(function(el) {\r\n            const isUser = el.classList.contains('humata-message-user');\r\n            const isError = el.classList.contains('humata-message-error');\r\n\r\n            if (isError) {\r\n                return;\r\n            }\r\n\r\n            const content = el.querySelector('.humata-message-content');\r\n            if (!content) {\r\n                return;\r\n            }\r\n\r\n            const text = getMessagePlainText(content);\r\n            if (!text) {\r\n                return;\r\n            }\r\n\r\n            history.push({\r\n                type: isUser ? 'user' : 'bot',\r\n                content: text\r\n            });\r\n        });\r\n\r\n        return history;\r\n    }\r\n\r\n    /**\r\n     * Add a message to the chat.\r\n     *\r\n     * @param {string} content - Message content.\r\n     * @param {string} type - Message type ('user' or 'bot').\r\n     * @param {boolean} isError - Whether this is an error message.\r\n     * @returns {HTMLElement} The message element.\r\n     */\r\n    function addMessage(content, type, isError = false) {\r\n        // Hide welcome message when first message is added\r\n        if (elements.welcomeMessage) {\r\n            elements.welcomeMessage.style.display = 'none';\r\n        }\r\n\r\n        const messageDiv = document.createElement('div');\r\n        messageDiv.className = 'humata-message humata-message-' + type;\r\n\r\n        if (isError) {\r\n            messageDiv.classList.add('humata-message-error');\r\n        }\r\n\r\n        // Avatar\r\n        const avatarDiv = document.createElement('div');\r\n        avatarDiv.className = 'humata-message-avatar';\r\n        setAvatarContent(avatarDiv, type);\r\n\r\n        // Content\r\n        const contentDiv = document.createElement('div');\r\n        contentDiv.className = 'humata-message-content';\r\n\r\n        // Parse markdown-like formatting for bot messages\r\n        if (type === 'bot' && !isError) {\r\n            contentDiv.innerHTML = formatMessage(content);\r\n        } else {\r\n            contentDiv.textContent = content;\r\n        }\r\n\r\n        ensureCopyButton(contentDiv);\r\n        if (type === 'bot') {\r\n            ensureRegenerateButton(contentDiv);\r\n        }\r\n        if (type === 'user' && !isError) {\r\n            ensureEditButton(contentDiv);\r\n        }\r\n\r\n        messageDiv.appendChild(avatarDiv);\r\n        messageDiv.appendChild(contentDiv);\r\n        elements.messages.appendChild(messageDiv);\r\n\r\n        // Update bot response disclaimer position for bot messages\r\n        if (type === 'bot' && !isError) {\r\n            updateBotResponseDisclaimerPosition();\r\n        }\r\n\r\n        // Scroll to bottom\r\n        scrollToBottom();\r\n\r\n        // Save to history\r\n        saveHistory();\r\n\r\n        return messageDiv;\r\n    }\r\n\r\n    /**\r\n     * Format message content with Markdown \u2192 HTML support for bot messages.\r\n     * Raw HTML is always escaped/treated as text for safety.\r\n     *\r\n     * @param {string} content - Raw message content.\r\n     * @returns {string} Formatted HTML content.\r\n     */\r\n    function formatMessage(content) {\r\n        if (!content) {\r\n            return '';\r\n        }\r\n\r\n        // Normalize newlines and escape raw HTML first.\r\n        let formatted = escapeHtml(String(content).replace(/\\r\\n?/g, '\\n'));\r\n\r\n        // Extract fenced code blocks (```lang ... ```) so we don't parse Markdown inside them.\r\n        const codeBlocks = [];\r\n        formatted = formatted.replace(/```([a-zA-Z0-9_-]*)\\n?([\\s\\S]*?)```/g, function(match, lang, code) {\r\n            const token = '%%HUMATA_CODEBLOCK_' + codeBlocks.length + '%%';\r\n            const safeLang = sanitizeCodeLanguage(lang || 'plaintext');\r\n            codeBlocks.push('<pre><code class=\"language-' + safeLang + '\">' + code.trim() + '</code></pre>');\r\n            // Surround with newlines so tokens become standalone blocks.\r\n            return '\\n' + token + '\\n';\r\n        });\r\n\r\n        // Render Markdown blocks into HTML.\r\n        let html = renderMarkdownBlocks(formatted);\r\n\r\n        // Restore code blocks.\r\n        html = html.replace(/%%HUMATA_CODEBLOCK_(\\d+)%%/g, function(match, idx) {\r\n            const i = parseInt(idx, 10);\r\n            return (Number.isFinite(i) && codeBlocks[i]) ? codeBlocks[i] : '';\r\n        });\r\n\r\n        return html;\r\n    }\r\n\r\n    let humataHtmlEntityDecoder = null;\r\n\r\n    /**\r\n     * Decode HTML entities in a string (e.g., &amp; / &#x3A;).\r\n     * Used to validate link schemes safely.\r\n     *\r\n     * @param {string} text\r\n     * @returns {string}\r\n     */\r\n    function decodeHtmlEntities(text) {\r\n        if (text == null) {\r\n            return '';\r\n        }\r\n\r\n        if (!humataHtmlEntityDecoder) {\r\n            humataHtmlEntityDecoder = document.createElement('textarea');\r\n        }\r\n\r\n        humataHtmlEntityDecoder.innerHTML = String(text);\r\n        return humataHtmlEntityDecoder.value;\r\n    }\r\n\r\n    /**\r\n     * Sanitize a fenced code block language string for use in a CSS class name.\r\n     *\r\n     * @param {string} lang\r\n     * @returns {string}\r\n     */\r\n    function sanitizeCodeLanguage(lang) {\r\n        const clean = String(lang || '')\r\n            .toLowerCase()\r\n            .replace(/[^\\w-]+/g, '');\r\n        return clean || 'plaintext';\r\n    }\r\n\r\n    /**\r\n     * Sanitize link href to avoid unsafe schemes (e.g., javascript:).\r\n     * Returns an HTML-escaped href string safe to insert into an attribute, or an empty string.\r\n     *\r\n     * @param {string} href\r\n     * @returns {string}\r\n     */\r\n    function sanitizeLinkHref(href) {\r\n        if (!href) {\r\n            return '';\r\n        }\r\n\r\n        const decoded = decodeHtmlEntities(String(href)).trim();\r\n        if (!decoded) {\r\n            return '';\r\n        }\r\n\r\n        // Strip whitespace/control characters when evaluating scheme.\r\n        const cleaned = decoded.replace(/[\\u0000-\\u001F\\u007F\\s]+/g, '');\r\n        if (!cleaned) {\r\n            return '';\r\n        }\r\n\r\n        // Allow common relative forms and anchors.\r\n        if (\r\n            cleaned.startsWith('#') ||\r\n            cleaned.startsWith('/') ||\r\n            cleaned.startsWith('./') ||\r\n            cleaned.startsWith('../') ||\r\n            cleaned.startsWith('?') ||\r\n            cleaned.startsWith('//')\r\n        ) {\r\n            return escapeHtml(decoded);\r\n        }\r\n\r\n        const schemeMatch = cleaned.match(/^([a-zA-Z][a-zA-Z0-9+.-]*):/);\r\n        if (schemeMatch) {\r\n            const scheme = (schemeMatch[1] || '').toLowerCase();\r\n            const allowed = scheme === 'http' || scheme === 'https' || scheme === 'mailto' || scheme === 'tel';\r\n            if (!allowed) {\r\n                return '';\r\n            }\r\n        }\r\n\r\n        return escapeHtml(decoded);\r\n    }\r\n\r\n    let humataPreparedAutoLinks = null;\r\n\r\n    function humataIsWordChar(ch) {\r\n        return !!ch && /[A-Za-z0-9]/.test(ch);\r\n    }\r\n\r\n    function getPreparedAutoLinks() {\r\n        if (humataPreparedAutoLinks !== null) {\r\n            return humataPreparedAutoLinks;\r\n        }\r\n\r\n        const raw = Array.isArray(config.autoLinks) ? config.autoLinks : [];\r\n        const prepared = [];\r\n\r\n        for (let i = 0; i < raw.length; i++) {\r\n            const row = raw[i];\r\n            if (!row || typeof row !== 'object') {\r\n                continue;\r\n            }\r\n\r\n            const phrase = String(row.phrase || '').trim();\r\n            const url = String(row.url || '').trim();\r\n            if (!phrase || !url) {\r\n                continue;\r\n            }\r\n\r\n            const safeHrefEscaped = sanitizeLinkHref(url);\r\n            if (!safeHrefEscaped) {\r\n                continue;\r\n            }\r\n\r\n            prepared.push({\r\n                phrase: phrase,\r\n                phraseLower: phrase.toLowerCase(),\r\n                href: decodeHtmlEntities(safeHrefEscaped),\r\n                len: phrase.length,\r\n                startsWord: humataIsWordChar(phrase.charAt(0)),\r\n                endsWord: humataIsWordChar(phrase.charAt(phrase.length - 1))\r\n            });\r\n\r\n            if (prepared.length >= 200) {\r\n                break;\r\n            }\r\n        }\r\n\r\n        prepared.sort(function(a, b) {\r\n            return b.len - a.len;\r\n        });\r\n\r\n        humataPreparedAutoLinks = prepared;\r\n        return humataPreparedAutoLinks;\r\n    }\r\n\r\n    function humataFindAutoLinkMatches(text, rules) {\r\n        if (!text) {\r\n            return [];\r\n        }\r\n\r\n        const haystack = String(text);\r\n        const lower = haystack.toLowerCase();\r\n        const matches = [];\r\n\r\n        function overlaps(start, end) {\r\n            for (let i = 0; i < matches.length; i++) {\r\n                const m = matches[i];\r\n                if (start < m.end && m.start < end) {\r\n                    return true;\r\n                }\r\n            }\r\n            return false;\r\n        }\r\n\r\n        for (let r = 0; r < rules.length; r++) {\r\n            const rule = rules[r];\r\n            if (!rule || !rule.phraseLower) {\r\n                continue;\r\n            }\r\n\r\n            let idx = 0;\r\n            while (true) {\r\n                idx = lower.indexOf(rule.phraseLower, idx);\r\n                if (idx === -1) {\r\n                    break;\r\n                }\r\n\r\n                const start = idx;\r\n                const end = idx + rule.phraseLower.length;\r\n\r\n                // Boundary checks: avoid matching inside other words (e.g., \"Liver\" inside \"Deliver\").\r\n                if (rule.startsWord) {\r\n                    const before = start > 0 ? haystack.charAt(start - 1) : '';\r\n                    if (before && humataIsWordChar(before)) {\r\n                        idx = idx + 1;\r\n                        continue;\r\n                    }\r\n                }\r\n                if (rule.endsWord) {\r\n                    const after = end < haystack.length ? haystack.charAt(end) : '';\r\n                    if (after && humataIsWordChar(after)) {\r\n                        idx = idx + 1;\r\n                        continue;\r\n                    }\r\n                }\r\n\r\n                if (!overlaps(start, end)) {\r\n                    matches.push({\r\n                        start: start,\r\n                        end: end,\r\n                        href: rule.href\r\n                    });\r\n                }\r\n\r\n                idx = end;\r\n            }\r\n        }\r\n\r\n        return matches;\r\n    }\r\n\r\n    function humataApplyAutoLinksToInlineHtml(html) {\r\n        if (!html) {\r\n            return html;\r\n        }\r\n\r\n        const rules = getPreparedAutoLinks();\r\n        if (!rules || !rules.length) {\r\n            return html;\r\n        }\r\n\r\n        if (typeof document === 'undefined' || !document.createElement || !document.createTreeWalker || typeof NodeFilter === 'undefined') {\r\n            return html;\r\n        }\r\n\r\n        const container = document.createElement('div');\r\n        try {\r\n            container.innerHTML = String(html);\r\n        } catch (e) {\r\n            return html;\r\n        }\r\n\r\n        let walker;\r\n        try {\r\n            walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT, {\r\n                acceptNode: function(node) {\r\n                    const value = node && node.nodeValue ? String(node.nodeValue) : '';\r\n                    if (!value || !value.trim()) {\r\n                        return NodeFilter.FILTER_REJECT;\r\n                    }\r\n\r\n                    // Skip text inside existing links (avoid nested anchors) and code/pre blocks.\r\n                    let p = node.parentNode;\r\n                    while (p && p !== container) {\r\n                        const name = p.nodeName;\r\n                        if (name === 'A' || name === 'CODE' || name === 'PRE') {\r\n                            return NodeFilter.FILTER_REJECT;\r\n                        }\r\n                        p = p.parentNode;\r\n                    }\r\n\r\n                    return NodeFilter.FILTER_ACCEPT;\r\n                }\r\n            });\r\n        } catch (e) {\r\n            return html;\r\n        }\r\n\r\n        const nodes = [];\r\n        let node;\r\n        while ((node = walker.nextNode())) {\r\n            nodes.push(node);\r\n        }\r\n\r\n        for (let i = 0; i < nodes.length; i++) {\r\n            const textNode = nodes[i];\r\n            const text = textNode && textNode.nodeValue ? String(textNode.nodeValue) : '';\r\n            if (!text) {\r\n                continue;\r\n            }\r\n\r\n            const matches = humataFindAutoLinkMatches(text, rules);\r\n            if (!matches.length) {\r\n                continue;\r\n            }\r\n\r\n            matches.sort(function(a, b) {\r\n                return a.start - b.start;\r\n            });\r\n\r\n            const frag = document.createDocumentFragment();\r\n            let lastIndex = 0;\r\n\r\n            for (let m = 0; m < matches.length; m++) {\r\n                const match = matches[m];\r\n                if (!match || match.start < lastIndex) {\r\n                    continue;\r\n                }\r\n\r\n                if (match.start > lastIndex) {\r\n                    frag.appendChild(document.createTextNode(text.slice(lastIndex, match.start)));\r\n                }\r\n\r\n                const a = document.createElement('a');\r\n                a.setAttribute('href', match.href);\r\n                a.setAttribute('target', '_blank');\r\n                a.setAttribute('rel', 'noopener noreferrer');\r\n                a.textContent = text.slice(match.start, match.end);\r\n                frag.appendChild(a);\r\n\r\n                lastIndex = match.end;\r\n            }\r\n\r\n            if (lastIndex < text.length) {\r\n                frag.appendChild(document.createTextNode(text.slice(lastIndex)));\r\n            }\r\n\r\n            if (textNode.parentNode) {\r\n                textNode.parentNode.replaceChild(frag, textNode);\r\n            }\r\n        }\r\n\r\n        return container.innerHTML;\r\n    }\r\n\r\n    function isBlankLine(line) {\r\n        return !line || /^\\s*$/.test(line);\r\n    }\r\n\r\n    function isCodeBlockTokenLine(line) {\r\n        return /^%%HUMATA_CODEBLOCK_\\d+%%$/.test(String(line || '').trim());\r\n    }\r\n\r\n    function isHorizontalRuleLine(line) {\r\n        return /^\\s{0,3}(-{3,}|\\*{3,})\\s*$/.test(String(line || ''));\r\n    }\r\n\r\n    function parseHeadingLine(line) {\r\n        const match = String(line || '').match(/^\\s{0,3}(#{1,6})\\s+(.+?)\\s*$/);\r\n        if (!match) {\r\n            return null;\r\n        }\r\n        return {\r\n            level: match[1].length,\r\n            text: match[2]\r\n        };\r\n    }\r\n\r\n    function isBlockquoteLine(line) {\r\n        return /^\\s{0,3}>\\s?/.test(String(line || ''));\r\n    }\r\n\r\n    function stripBlockquotePrefix(line) {\r\n        return String(line || '').replace(/^\\s{0,3}>\\s?/, '');\r\n    }\r\n\r\n    function isUnorderedListLine(line) {\r\n        return /^\\s{0,3}[-+*]\\s+/.test(String(line || ''));\r\n    }\r\n\r\n    function isOrderedListLine(line) {\r\n        return /^\\s{0,3}\\d+\\.\\s+/.test(String(line || ''));\r\n    }\r\n\r\n    /**\r\n     * Render inline Markdown within a single block of text.\r\n     *\r\n     * @param {string} text - HTML-escaped text.\r\n     * @returns {string}\r\n     */\r\n    function renderInlineMarkdown(text) {\r\n        if (!text) {\r\n            return '';\r\n        }\r\n\r\n        let out = String(text);\r\n\r\n        // Protect inline code spans first so we don't apply other formatting within them.\r\n        const codeSpans = [];\r\n        out = out.replace(/`([^`]+)`/g, function(match, code) {\r\n            const token = '%%HUMATA_CODESPAN_' + codeSpans.length + '%%';\r\n            codeSpans.push('<code>' + code + '</code>');\r\n            return token;\r\n        });\r\n\r\n        // Links: [label](url)\r\n        out = out.replace(/\\[([^\\]]+)\\]\\(([^)]+)\\)/g, function(match, label, url) {\r\n            const safeHref = sanitizeLinkHref(url);\r\n            if (!safeHref) {\r\n                // Render as plain text if unsafe.\r\n                return label + ' (' + url + ')';\r\n            }\r\n            return '<a href=\"' + safeHref + '\" target=\"_blank\" rel=\"noopener noreferrer\">' + label + '</a>';\r\n        });\r\n\r\n        // Bold: **text**\r\n        out = out.replace(/\\*\\*([^*]+)\\*\\*/g, '<strong>$1</strong>');\r\n\r\n        // Italic: *text* (avoid consuming **bold**)\r\n        out = out.replace(/(^|[^*])\\*([^*\\n]+)\\*(?!\\*)/g, '$1<em>$2</em>');\r\n\r\n        // Auto-link configured phrases while avoiding existing anchors and code tokens.\r\n        out = humataApplyAutoLinksToInlineHtml(out);\r\n\r\n        // Restore code spans.\r\n        out = out.replace(/%%HUMATA_CODESPAN_(\\d+)%%/g, function(match, idx) {\r\n            const i = parseInt(idx, 10);\r\n            return (Number.isFinite(i) && codeSpans[i]) ? codeSpans[i] : match;\r\n        });\r\n\r\n        return out;\r\n    }\r\n\r\n    /**\r\n     * Render a limited, safe subset of Markdown into HTML block elements.\r\n     *\r\n     * @param {string} text - HTML-escaped text.\r\n     * @returns {string}\r\n     */\r\n    function renderMarkdownBlocks(text) {\r\n        if (!text) {\r\n            return '';\r\n        }\r\n\r\n        const lines = String(text).split('\\n');\r\n        const out = [];\r\n        let i = 0;\r\n\r\n        while (i < lines.length) {\r\n            const line = lines[i];\r\n\r\n            if (isBlankLine(line)) {\r\n                i++;\r\n                continue;\r\n            }\r\n\r\n            // Standalone code block token (block-level).\r\n            if (isCodeBlockTokenLine(line)) {\r\n                out.push(String(line).trim());\r\n                i++;\r\n                continue;\r\n            }\r\n\r\n            // Horizontal rule.\r\n            if (isHorizontalRuleLine(line)) {\r\n                out.push('<hr>');\r\n                i++;\r\n                continue;\r\n            }\r\n\r\n            // Heading.\r\n            const heading = parseHeadingLine(line);\r\n            if (heading) {\r\n                out.push('<h' + heading.level + '>' + renderInlineMarkdown(heading.text) + '</h' + heading.level + '>');\r\n                i++;\r\n                continue;\r\n            }\r\n\r\n            // Blockquote.\r\n            if (isBlockquoteLine(line)) {\r\n                const quoteLines = [];\r\n                while (i < lines.length && isBlockquoteLine(lines[i])) {\r\n                    quoteLines.push(stripBlockquotePrefix(lines[i]));\r\n                    i++;\r\n                }\r\n                out.push('<blockquote>' + renderMarkdownBlocks(quoteLines.join('\\n')) + '</blockquote>');\r\n                continue;\r\n            }\r\n\r\n            // Unordered list.\r\n            if (isUnorderedListLine(line)) {\r\n                const items = [];\r\n                while (i < lines.length) {\r\n                    const current = lines[i];\r\n\r\n                    if (isBlankLine(current)) {\r\n                        // Allow blank lines within a list if the next non-blank continues it.\r\n                        let j = i + 1;\r\n                        while (j < lines.length && isBlankLine(lines[j])) {\r\n                            j++;\r\n                        }\r\n                        if (j < lines.length && isUnorderedListLine(lines[j])) {\r\n                            i = j;\r\n                            continue;\r\n                        }\r\n                        break;\r\n                    }\r\n\r\n                    if (!isUnorderedListLine(current)) {\r\n                        break;\r\n                    }\r\n\r\n                    const itemText = String(current).replace(/^\\s{0,3}[-+*]\\s+/, '');\r\n                    items.push('<li>' + renderInlineMarkdown(itemText) + '</li>');\r\n                    i++;\r\n                }\r\n\r\n                out.push('<ul>' + items.join('') + '</ul>');\r\n                continue;\r\n            }\r\n\r\n            // Ordered list.\r\n            if (isOrderedListLine(line)) {\r\n                const items = [];\r\n                while (i < lines.length) {\r\n                    const current = lines[i];\r\n\r\n                    if (isBlankLine(current)) {\r\n                        let j = i + 1;\r\n                        while (j < lines.length && isBlankLine(lines[j])) {\r\n                            j++;\r\n                        }\r\n                        if (j < lines.length && isOrderedListLine(lines[j])) {\r\n                            i = j;\r\n                            continue;\r\n                        }\r\n                        break;\r\n                    }\r\n\r\n                    if (!isOrderedListLine(current)) {\r\n                        break;\r\n                    }\r\n\r\n                    const itemText = String(current).replace(/^\\s{0,3}\\d+\\.\\s+/, '');\r\n                    items.push('<li>' + renderInlineMarkdown(itemText) + '</li>');\r\n                    i++;\r\n                }\r\n\r\n                out.push('<ol>' + items.join('') + '</ol>');\r\n                continue;\r\n            }\r\n\r\n            // Paragraph: gather consecutive non-blank, non-block-start lines.\r\n            const paraLines = [];\r\n            while (i < lines.length) {\r\n                const current = lines[i];\r\n\r\n                if (isBlankLine(current)) {\r\n                    break;\r\n                }\r\n\r\n                if (\r\n                    isCodeBlockTokenLine(current) ||\r\n                    isHorizontalRuleLine(current) ||\r\n                    parseHeadingLine(current) ||\r\n                    isBlockquoteLine(current) ||\r\n                    isUnorderedListLine(current) ||\r\n                    isOrderedListLine(current)\r\n                ) {\r\n                    break;\r\n                }\r\n\r\n                paraLines.push(String(current).trim());\r\n                i++;\r\n            }\r\n\r\n            const paraText = paraLines.join(' ').trim();\r\n            if (paraText) {\r\n                out.push('<p>' + renderInlineMarkdown(paraText) + '</p>');\r\n            }\r\n        }\r\n\r\n        return out.join('');\r\n    }\r\n\r\n    /**\r\n     * Escape HTML special characters.\r\n     *\r\n     * @param {string} text - Text to escape.\r\n     * @returns {string} Escaped text.\r\n     */\r\n    function escapeHtml(text) {\r\n        const div = document.createElement('div');\r\n        div.textContent = text;\r\n        return div.innerHTML;\r\n    }\r\n\r\n    function getOrCreateMessageActionsContainer(contentEl) {\r\n        if (!contentEl) {\r\n            return null;\r\n        }\r\n\r\n        let actionsEl = contentEl.querySelector('.humata-message-actions');\r\n        if (actionsEl) {\r\n            return actionsEl;\r\n        }\r\n\r\n        actionsEl = document.createElement('div');\r\n        actionsEl.className = 'humata-message-actions';\r\n        contentEl.appendChild(actionsEl);\r\n        return actionsEl;\r\n    }\r\n\r\n    function ensureCopyButton(contentEl) {\r\n        if (!contentEl || contentEl.querySelector('.humata-copy-button')) {\r\n            return;\r\n        }\r\n\r\n        contentEl.classList.add('humata-message-content-has-copy');\r\n\r\n        const button = document.createElement('button');\r\n        button.type = 'button';\r\n        button.className = 'humata-copy-button';\r\n        button.innerHTML = getCopyIconSvg();\r\n        button.setAttribute('title', 'Copy');\r\n        button.setAttribute('aria-label', 'Copy message');\r\n\r\n        const actionsEl = getOrCreateMessageActionsContainer(contentEl);\r\n        if (!actionsEl) {\r\n            return;\r\n        }\r\n\r\n        actionsEl.appendChild(button);\r\n    }\r\n\r\n    function ensureRegenerateButton(contentEl) {\r\n        if (!contentEl || contentEl.querySelector('.humata-regenerate-button')) {\r\n            return;\r\n        }\r\n\r\n        contentEl.classList.add('humata-message-content-has-regenerate');\r\n\r\n        const button = document.createElement('button');\r\n        button.type = 'button';\r\n        button.className = 'humata-regenerate-button';\r\n        button.innerHTML = getRegenerateIconSvg();\r\n        button.setAttribute('title', config.i18n?.regenerate || 'Regenerate');\r\n        button.setAttribute('aria-label', config.i18n?.regenerate || 'Regenerate');\r\n\r\n        const actionsEl = getOrCreateMessageActionsContainer(contentEl);\r\n        if (!actionsEl) {\r\n            return;\r\n        }\r\n\r\n        actionsEl.appendChild(button);\r\n    }\r\n\r\n    function ensureEditButton(contentEl) {\r\n        if (!contentEl || contentEl.querySelector('.humata-edit-button')) {\r\n            return;\r\n        }\r\n\r\n        contentEl.classList.add('humata-message-content-has-edit');\r\n\r\n        const button = document.createElement('button');\r\n        button.type = 'button';\r\n        button.className = 'humata-edit-button';\r\n        button.innerHTML = getEditIconSvg();\r\n        button.setAttribute('title', config.i18n?.editMessage || 'Edit message');\r\n        button.setAttribute('aria-label', config.i18n?.editMessage || 'Edit message');\r\n\r\n        const actionsEl = getOrCreateMessageActionsContainer(contentEl);\r\n        if (!actionsEl) {\r\n            return;\r\n        }\r\n\r\n        actionsEl.appendChild(button);\r\n    }\r\n\r\n    function getMessagePlainText(contentEl) {\r\n        const editTextarea = contentEl ? contentEl.querySelector('.humata-edit-textarea') : null;\r\n        if (editTextarea) {\r\n            return (editTextarea.value || '').trim();\r\n        }\r\n\r\n        const cloned = contentEl.cloneNode(true);\r\n        cloned.querySelectorAll('.humata-copy-button').forEach(function(btn) {\r\n            btn.remove();\r\n        });\r\n        cloned.querySelectorAll('.humata-regenerate-button').forEach(function(btn) {\r\n            btn.remove();\r\n        });\r\n        cloned.querySelectorAll('.humata-edit-button').forEach(function(btn) {\r\n            btn.remove();\r\n        });\r\n        cloned.querySelectorAll('.humata-edit-actions').forEach(function(el) {\r\n            el.remove();\r\n        });\r\n        cloned.querySelectorAll('.humata-message-actions').forEach(function(el) {\r\n            el.remove();\r\n        });\r\n        cloned.querySelectorAll('.humata-bot-response-disclaimer').forEach(function(el) {\r\n            el.remove();\r\n        });\r\n        cloned.querySelectorAll('.humata-intent-links').forEach(function(el) {\r\n            el.remove();\r\n        });\r\n        cloned.querySelectorAll('.humata-accordions').forEach(function(el) {\r\n            el.remove();\r\n        });\r\n        return ((cloned.innerText || cloned.textContent || '') + '').trim();\r\n    }\r\n\r\n    function getMessageHtmlForStorage(contentEl) {\r\n        const cloned = contentEl.cloneNode(true);\r\n        cloned.querySelectorAll('.humata-copy-button').forEach(function(btn) {\r\n            btn.remove();\r\n        });\r\n        cloned.querySelectorAll('.humata-regenerate-button').forEach(function(btn) {\r\n            btn.remove();\r\n        });\r\n        cloned.querySelectorAll('.humata-edit-button').forEach(function(btn) {\r\n            btn.remove();\r\n        });\r\n        cloned.querySelectorAll('.humata-edit-actions').forEach(function(el) {\r\n            el.remove();\r\n        });\r\n        cloned.querySelectorAll('.humata-message-actions').forEach(function(el) {\r\n            el.remove();\r\n        });\r\n        cloned.querySelectorAll('.humata-bot-response-disclaimer').forEach(function(el) {\r\n            el.remove();\r\n        });\r\n        cloned.querySelectorAll('.humata-intent-links').forEach(function(el) {\r\n            el.remove();\r\n        });\r\n        cloned.querySelectorAll('.humata-accordions').forEach(function(el) {\r\n            el.remove();\r\n        });\r\n        return cloned.innerHTML;\r\n    }\r\n\r\n    function getMessageClipboardPayload(contentEl) {\r\n        const editTextarea = contentEl ? contentEl.querySelector('.humata-edit-textarea') : null;\r\n        if (editTextarea) {\r\n            const text = (editTextarea.value || '').trim();\r\n            return {\r\n                text: text,\r\n                html: text ? '<div>' + escapeHtml(text).replace(/\\n/g, '<br>') + '</div>' : ''\r\n            };\r\n        }\r\n\r\n        const innerHtml = contentEl ? getMessageHtmlForStorage(contentEl) : '';\r\n        if (!innerHtml) {\r\n            return { text: '', html: '' };\r\n        }\r\n\r\n        return {\r\n            text: htmlFragmentToPlainText(innerHtml),\r\n            html: '<div>' + innerHtml + '</div>'\r\n        };\r\n    }\r\n\r\n    function htmlFragmentToPlainText(html) {\r\n        if (!html) {\r\n            return '';\r\n        }\r\n\r\n        const container = document.createElement('div');\r\n        container.innerHTML = html;\r\n\r\n        const text = domNodeToPlainText(container, { listStack: [] });\r\n\r\n        return String(text || '')\r\n            .replace(/\\r\\n?/g, '\\n')\r\n            .replace(/[ \\t]+\\n/g, '\\n')\r\n            .replace(/\\n{3,}/g, '\\n\\n')\r\n            .trim();\r\n    }\r\n\r\n    function domNodeToPlainText(node, ctx) {\r\n        if (!node) {\r\n            return '';\r\n        }\r\n\r\n        const type = node.nodeType;\r\n        // Text node\r\n        if (type === 3) {\r\n            return node.nodeValue || '';\r\n        }\r\n\r\n        // Only process elements\r\n        if (type !== 1) {\r\n            return '';\r\n        }\r\n\r\n        const tag = (node.tagName || '').toLowerCase();\r\n\r\n        function childrenText() {\r\n            let out = '';\r\n            const children = node.childNodes || [];\r\n            for (let i = 0; i < children.length; i++) {\r\n                out += domNodeToPlainText(children[i], ctx);\r\n            }\r\n            return out;\r\n        }\r\n\r\n        function ensureEndsWithNewline(out) {\r\n            if (!out) {\r\n                return '\\n';\r\n            }\r\n            return out.endsWith('\\n') ? out : out + '\\n';\r\n        }\r\n\r\n        function ensureBlankLine(out) {\r\n            let t = ensureEndsWithNewline(out);\r\n            if (!t.endsWith('\\n\\n')) {\r\n                t += '\\n';\r\n            }\r\n            return t;\r\n        }\r\n\r\n        if (tag === 'br') {\r\n            return '\\n';\r\n        }\r\n\r\n        if (tag === 'hr') {\r\n            return '\\n\\n';\r\n        }\r\n\r\n        if (tag === 'pre') {\r\n            const block = node.textContent || '';\r\n            return ensureBlankLine(block.replace(/\\n$/, ''));\r\n        }\r\n\r\n        if (tag === 'p' || tag === 'div' || tag === 'section') {\r\n            const t = childrenText().trim();\r\n            return t ? ensureBlankLine(t) : '';\r\n        }\r\n\r\n        if (tag === 'blockquote') {\r\n            const t = childrenText().trim();\r\n            return t ? ensureBlankLine(t) : '';\r\n        }\r\n\r\n        if (/^h[1-6]$/.test(tag)) {\r\n            const t = childrenText().trim();\r\n            return t ? ensureBlankLine(t) : '';\r\n        }\r\n\r\n        if (tag === 'ul' || tag === 'ol') {\r\n            ctx.listStack.push({ type: tag, index: 0 });\r\n            let out = '';\r\n            const children = node.childNodes || [];\r\n            for (let i = 0; i < children.length; i++) {\r\n                out += domNodeToPlainText(children[i], ctx);\r\n            }\r\n            ctx.listStack.pop();\r\n            return ensureBlankLine(out.trim());\r\n        }\r\n\r\n        if (tag === 'li') {\r\n            const stack = ctx.listStack || [];\r\n            const current = stack.length ? stack[stack.length - 1] : null;\r\n            let prefix = '- ';\r\n            if (current && current.type === 'ol') {\r\n                current.index += 1;\r\n                prefix = String(current.index) + '. ';\r\n            } else if (current && current.type === 'ul') {\r\n                prefix = '\u2022 ';\r\n            }\r\n\r\n            const indent = stack.length > 1 ? '  '.repeat(stack.length - 1) : '';\r\n            const t = childrenText().trim();\r\n            return t ? indent + prefix + t + '\\n' : '';\r\n        }\r\n\r\n        // Default inline-ish handling\r\n        return childrenText();\r\n    }\r\n\r\n    function copyToClipboard(payload) {\r\n        if (payload == null) {\r\n            return Promise.reject(new Error('Nothing to copy'));\r\n        }\r\n\r\n        // Backward-compatible plain text copy\r\n        if (typeof payload === 'string') {\r\n            return copyPlainTextToClipboard(payload);\r\n        }\r\n\r\n        const text = String(payload.text || '');\r\n        const html = String(payload.html || '');\r\n\r\n        // Prefer the modern async clipboard API when available.\r\n        if (html && navigator.clipboard && navigator.clipboard.write && typeof ClipboardItem !== 'undefined') {\r\n            try {\r\n                const item = new ClipboardItem({\r\n                    'text/plain': new Blob([text], { type: 'text/plain' }),\r\n                    'text/html': new Blob([html], { type: 'text/html' })\r\n                });\r\n\r\n                return navigator.clipboard.write([item]).catch(function() {\r\n                    // Fall back to selection-based copy when permissions are denied.\r\n                    return copyHtmlWithSelection(html);\r\n                });\r\n            } catch (e) {\r\n                // Fall through to legacy method\r\n            }\r\n        }\r\n\r\n        if (html) {\r\n            return copyHtmlWithSelection(html);\r\n        }\r\n\r\n        return copyPlainTextToClipboard(text);\r\n    }\r\n\r\n    function copyHtmlWithSelection(html) {\r\n        return new Promise(function(resolve, reject) {\r\n            try {\r\n                const container = document.createElement('div');\r\n                container.setAttribute('aria-hidden', 'true');\r\n                container.style.position = 'fixed';\r\n                container.style.left = '-9999px';\r\n                container.style.top = '0';\r\n                container.style.width = '1px';\r\n                container.style.height = '1px';\r\n                container.style.overflow = 'hidden';\r\n                container.innerHTML = html;\r\n                document.body.appendChild(container);\r\n\r\n                const selection = window.getSelection ? window.getSelection() : null;\r\n                const savedRanges = [];\r\n                if (selection && selection.rangeCount) {\r\n                    for (let i = 0; i < selection.rangeCount; i++) {\r\n                        savedRanges.push(selection.getRangeAt(i).cloneRange());\r\n                    }\r\n                }\r\n\r\n                if (selection) {\r\n                    const range = document.createRange();\r\n                    range.selectNodeContents(container);\r\n                    selection.removeAllRanges();\r\n                    selection.addRange(range);\r\n                }\r\n\r\n                const successful = document.execCommand('copy');\r\n\r\n                if (selection) {\r\n                    selection.removeAllRanges();\r\n                    for (let i = 0; i < savedRanges.length; i++) {\r\n                        selection.addRange(savedRanges[i]);\r\n                    }\r\n                }\r\n\r\n                container.remove();\r\n\r\n                if (successful) {\r\n                    resolve();\r\n                } else {\r\n                    reject(new Error('Copy failed'));\r\n                }\r\n            } catch (e) {\r\n                reject(e);\r\n            }\r\n        });\r\n    }\r\n\r\n    function copyPlainTextToClipboard(text) {\r\n        if (navigator.clipboard && navigator.clipboard.writeText) {\r\n            return navigator.clipboard.writeText(text).catch(function() {\r\n                return copyPlainTextWithTextarea(text);\r\n            });\r\n        }\r\n\r\n        return copyPlainTextWithTextarea(text);\r\n    }\r\n\r\n    function copyPlainTextWithTextarea(text) {\r\n        return new Promise(function(resolve, reject) {\r\n            try {\r\n                const textarea = document.createElement('textarea');\r\n                textarea.value = String(text || '');\r\n                textarea.setAttribute('readonly', '');\r\n                textarea.style.position = 'fixed';\r\n                textarea.style.top = '-9999px';\r\n                textarea.style.left = '-9999px';\r\n                document.body.appendChild(textarea);\r\n                textarea.select();\r\n                textarea.setSelectionRange(0, textarea.value.length);\r\n                const successful = document.execCommand('copy');\r\n                textarea.remove();\r\n                if (successful) {\r\n                    resolve();\r\n                } else {\r\n                    reject(new Error('Copy failed'));\r\n                }\r\n            } catch (e) {\r\n                reject(e);\r\n            }\r\n        });\r\n    }\r\n\r\n    function indicateCopySuccess(button) {\r\n        if (!button) {\r\n            return;\r\n        }\r\n\r\n        if (!button.dataset.humataCopyDefault) {\r\n            button.dataset.humataCopyDefault = button.innerHTML;\r\n        }\r\n\r\n        if (button._humataCopyResetTimer) {\r\n            clearTimeout(button._humataCopyResetTimer);\r\n        }\r\n\r\n        button.innerHTML = getCheckIconSvg();\r\n        button.classList.add('humata-copy-button-success');\r\n        button.setAttribute('title', 'Copied');\r\n        button.setAttribute('aria-label', 'Copied');\r\n\r\n        button._humataCopyResetTimer = setTimeout(function() {\r\n            button.innerHTML = button.dataset.humataCopyDefault;\r\n            button.classList.remove('humata-copy-button-success');\r\n            button.setAttribute('title', 'Copy');\r\n            button.setAttribute('aria-label', 'Copy message');\r\n        }, 1500);\r\n    }\r\n\r\n    function indicateCopyFailure(button) {\r\n        if (!button) {\r\n            return;\r\n        }\r\n\r\n        button.setAttribute('title', 'Copy failed');\r\n        button.setAttribute('aria-label', 'Copy failed');\r\n\r\n        if (button._humataCopyResetTimer) {\r\n            clearTimeout(button._humataCopyResetTimer);\r\n        }\r\n\r\n        button._humataCopyResetTimer = setTimeout(function() {\r\n            button.setAttribute('title', 'Copy');\r\n            button.setAttribute('aria-label', 'Copy message');\r\n        }, 1500);\r\n    }\r\n\r\n    function getCopyIconSvg() {\r\n        return '<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.5\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><rect x=\"9\" y=\"9\" width=\"13\" height=\"13\" rx=\"2\" ry=\"2\"></rect><path d=\"M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1\"></path></svg>';\r\n    }\r\n\r\n    function getEditIconSvg() {\r\n        return '<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.5\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M12 20h9\"></path><path d=\"M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4Z\"></path></svg>';\r\n    }\r\n\r\n    function getRegenerateIconSvg() {\r\n        return '<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.5\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><polyline points=\"23 4 23 10 17 10\"></polyline><polyline points=\"1 20 1 14 7 14\"></polyline><path d=\"M3.51 9a9 9 0 0 1 14.13-3.36L23 10\"></path><path d=\"M1 14l5.36 5.36A9 9 0 0 0 20.49 15\"></path></svg>';\r\n    }\r\n\r\n    function getCheckIconSvg() {\r\n        return '<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.5\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M20 6 9 17l-5-5\"></path></svg>';\r\n    }\r\n\r\n    function getXIconSvg() {\r\n        return '<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.5\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M18 6 6 18\"></path><path d=\"m6 6 12 12\"></path></svg>';\r\n    }\r\n\r\n    /**\r\n     * Get or create the bot response disclaimer element.\r\n     * Returns null if no disclaimer is configured.\r\n     *\r\n     * @returns {HTMLElement|null}\r\n     */\r\n    function getBotResponseDisclaimerElement() {\r\n        const disclaimerHtml = config.botResponseDisclaimer;\r\n        if (!disclaimerHtml || typeof disclaimerHtml !== 'string' || !disclaimerHtml.trim()) {\r\n            return null;\r\n        }\r\n\r\n        let disclaimerEl = document.getElementById('humata-bot-response-disclaimer');\r\n        if (!disclaimerEl) {\r\n            disclaimerEl = document.createElement('div');\r\n            disclaimerEl.id = 'humata-bot-response-disclaimer';\r\n            disclaimerEl.className = 'humata-bot-response-disclaimer';\r\n            disclaimerEl.innerHTML = '<p>' + disclaimerHtml + '</p>';\r\n        }\r\n\r\n        return disclaimerEl;\r\n    }\r\n\r\n    /**\r\n     * Update the position of the bot response disclaimer to be inside the\r\n     * latest non-error bot message's content (after the message actions).\r\n     * Hides it if no suitable bot message exists.\r\n     */\r\n    function updateBotResponseDisclaimerPosition() {\r\n        const disclaimerEl = getBotResponseDisclaimerElement();\r\n        if (!disclaimerEl) {\r\n            return;\r\n        }\r\n\r\n        if (!elements.messages) {\r\n            disclaimerEl.remove();\r\n            return;\r\n        }\r\n\r\n        // Find the latest non-error, non-loading bot message\r\n        const botMessages = elements.messages.querySelectorAll(\r\n            '.humata-message-bot:not(.humata-message-error):not(.humata-message-loading):not(#humata-welcome-message)'\r\n        );\r\n\r\n        if (!botMessages.length) {\r\n            disclaimerEl.remove();\r\n            return;\r\n        }\r\n\r\n        const latestBotMessage = botMessages[botMessages.length - 1];\r\n        const contentEl = latestBotMessage.querySelector('.humata-message-content');\r\n\r\n        if (!contentEl) {\r\n            disclaimerEl.remove();\r\n            return;\r\n        }\r\n\r\n        // Append disclaimer inside the message content (after actions if present)\r\n        contentEl.appendChild(disclaimerEl);\r\n    }\r\n\r\n    /**\r\n     * Hide the bot response disclaimer temporarily (e.g., during loading).\r\n     */\r\n    function hideBotResponseDisclaimer() {\r\n        const disclaimerEl = document.getElementById('humata-bot-response-disclaimer');\r\n        if (disclaimerEl) {\r\n            disclaimerEl.remove();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Escape special regex characters in a string.\r\n     *\r\n     * @param {string} str - String to escape.\r\n     * @returns {string} Escaped string.\r\n     */\r\n    function escapeRegexChars(str) {\r\n        return String(str || '').replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&');\r\n    }\r\n\r\n    /**\r\n     * Find matching intent links based on the user's message.\r\n     * Matches keywords as whole words (case-insensitive).\r\n     *\r\n     * @param {string} userMessage - The user's question text.\r\n     * @returns {Array} Array of {title, url} objects to display (deduplicated).\r\n     */\r\n    function findMatchingIntentLinks(userMessage) {\r\n        const intents = config.intentLinks;\r\n        if (!intents || !Array.isArray(intents) || !intents.length) {\r\n            return [];\r\n        }\r\n\r\n        if (!userMessage || typeof userMessage !== 'string') {\r\n            return [];\r\n        }\r\n\r\n        const matchedLinks = [];\r\n        const seenUrls = new Set();\r\n\r\n        for (let i = 0; i < intents.length; i++) {\r\n            const intent = intents[i];\r\n            const keywords = intent.keywords;\r\n            const links = intent.links;\r\n\r\n            if (!keywords || !Array.isArray(keywords) || !keywords.length) {\r\n                continue;\r\n            }\r\n            if (!links || !Array.isArray(links) || !links.length) {\r\n                continue;\r\n            }\r\n\r\n            let matched = false;\r\n            for (let k = 0; k < keywords.length; k++) {\r\n                const keyword = keywords[k];\r\n                if (!keyword) {\r\n                    continue;\r\n                }\r\n\r\n                // Whole-word match (case-insensitive)\r\n                const pattern = new RegExp('\\\\b' + escapeRegexChars(keyword) + '\\\\b', 'i');\r\n                if (pattern.test(userMessage)) {\r\n                    matched = true;\r\n                    break;\r\n                }\r\n            }\r\n\r\n            if (matched) {\r\n                for (let j = 0; j < links.length; j++) {\r\n                    const link = links[j];\r\n                    if (!link || !link.title || !link.url) {\r\n                        continue;\r\n                    }\r\n                    if (!seenUrls.has(link.url)) {\r\n                        seenUrls.add(link.url);\r\n                        matchedLinks.push({\r\n                            title: link.title,\r\n                            url: link.url\r\n                        });\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        return matchedLinks;\r\n    }\r\n\r\n    /**\r\n     * Create the intent links element with pill-shaped buttons.\r\n     *\r\n     * @param {Array} links - Array of {title, url} objects.\r\n     * @returns {HTMLElement|null} The container element or null if no links.\r\n     */\r\n    function createIntentLinksElement(links) {\r\n        if (!links || !links.length) {\r\n            return null;\r\n        }\r\n\r\n        const container = document.createElement('div');\r\n        container.className = 'humata-intent-links';\r\n\r\n        const label = document.createElement('span');\r\n        label.className = 'humata-intent-links-label';\r\n        label.textContent = config.i18n?.relatedResources || 'Related resources:';\r\n        container.appendChild(label);\r\n\r\n        const pillsWrap = document.createElement('div');\r\n        pillsWrap.className = 'humata-intent-links-pills';\r\n\r\n        for (let i = 0; i < links.length; i++) {\r\n            const link = links[i];\r\n            const a = document.createElement('a');\r\n            a.href = link.url;\r\n            a.target = '_blank';\r\n            a.rel = 'noopener noreferrer';\r\n            a.className = 'humata-intent-link';\r\n            a.textContent = link.title;\r\n            pillsWrap.appendChild(a);\r\n        }\r\n\r\n        container.appendChild(pillsWrap);\r\n        return container;\r\n    }\r\n\r\n    /**\r\n     * Find matching intent accordions based on the user's message.\r\n     * Matches keywords as whole words (case-insensitive).\r\n     *\r\n     * @param {string} userMessage - The user's question text.\r\n     * @returns {Array} Array of {title, content} objects to display (deduplicated).\r\n     */\r\n    function findMatchingIntentAccordions(userMessage) {\r\n        const intents = config.intentLinks;\r\n        if (!intents || !Array.isArray(intents) || !intents.length) {\r\n            return [];\r\n        }\r\n\r\n        if (!userMessage || typeof userMessage !== 'string') {\r\n            return [];\r\n        }\r\n\r\n        const matchedAccordions = [];\r\n        const seenTitles = new Set();\r\n\r\n        for (let i = 0; i < intents.length; i++) {\r\n            const intent = intents[i];\r\n            const keywords = intent.keywords;\r\n            const accordions = intent.accordions;\r\n\r\n            if (!keywords || !Array.isArray(keywords) || !keywords.length) {\r\n                continue;\r\n            }\r\n            if (!accordions || !Array.isArray(accordions) || !accordions.length) {\r\n                continue;\r\n            }\r\n\r\n            let matched = false;\r\n            for (let k = 0; k < keywords.length; k++) {\r\n                const keyword = keywords[k];\r\n                if (!keyword) {\r\n                    continue;\r\n                }\r\n\r\n                // Whole-word match (case-insensitive)\r\n                const pattern = new RegExp('\\\\b' + escapeRegexChars(keyword) + '\\\\b', 'i');\r\n                if (pattern.test(userMessage)) {\r\n                    matched = true;\r\n                    break;\r\n                }\r\n            }\r\n\r\n            if (matched) {\r\n                for (let j = 0; j < accordions.length; j++) {\r\n                    const acc = accordions[j];\r\n                    if (!acc || !acc.title || !acc.content) {\r\n                        continue;\r\n                    }\r\n                    if (!seenTitles.has(acc.title)) {\r\n                        seenTitles.add(acc.title);\r\n                        matchedAccordions.push({\r\n                            title: acc.title,\r\n                            content: acc.content\r\n                        });\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        return matchedAccordions;\r\n    }\r\n\r\n    /**\r\n     * Create the accordion toggles element.\r\n     *\r\n     * @param {Array} accordions - Array of {title, content} objects.\r\n     * @returns {HTMLElement|null} The container element or null if no accordions.\r\n     */\r\n    function createAccordionElement(accordions) {\r\n        if (!accordions || !accordions.length) {\r\n            return null;\r\n        }\r\n\r\n        const container = document.createElement('div');\r\n        container.className = 'humata-accordions';\r\n\r\n        for (let i = 0; i < accordions.length; i++) {\r\n            const acc = accordions[i];\r\n\r\n            const item = document.createElement('div');\r\n            item.className = 'humata-accordion-item';\r\n\r\n            const toggle = document.createElement('button');\r\n            toggle.type = 'button';\r\n            toggle.className = 'humata-accordion-toggle';\r\n            toggle.innerHTML = '<span>' + escapeHtml(acc.title) + '</span>' +\r\n                '<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><polyline points=\"6 9 12 15 18 9\"></polyline></svg>';\r\n\r\n            toggle.addEventListener('click', function() {\r\n                item.classList.toggle('open');\r\n            });\r\n\r\n            const content = document.createElement('div');\r\n            content.className = 'humata-accordion-content';\r\n            content.innerHTML = acc.content; // Pre-sanitized server-side\r\n\r\n            item.appendChild(toggle);\r\n            item.appendChild(content);\r\n            container.appendChild(item);\r\n        }\r\n\r\n        return container;\r\n    }\r\n\r\n    /**\r\n     * Append intent links and accordions to a bot message element based on the user's question.\r\n     *\r\n     * @param {HTMLElement} botMessageEl - The bot message element.\r\n     * @param {string} userMessage - The user's original question.\r\n     */\r\n    function appendIntentLinksToMessage(botMessageEl, userMessage) {\r\n        if (!botMessageEl || !userMessage) {\r\n            return;\r\n        }\r\n\r\n        const contentEl = botMessageEl.querySelector('.humata-message-content');\r\n        if (!contentEl) {\r\n            return;\r\n        }\r\n\r\n        // Find matching accordions and links\r\n        const accordions = findMatchingIntentAccordions(userMessage);\r\n        const links = findMatchingIntentLinks(userMessage);\r\n\r\n        // Create accordion element if any matched\r\n        const accordionEl = createAccordionElement(accordions);\r\n        if (accordionEl) {\r\n            // Store matched accordions on element for potential export\r\n            botMessageEl._humataIntentAccordions = accordions;\r\n\r\n            // Insert accordions before message-actions if present\r\n            const actionsEl = contentEl.querySelector('.humata-message-actions');\r\n            if (actionsEl) {\r\n                contentEl.insertBefore(accordionEl, actionsEl);\r\n            } else {\r\n                contentEl.appendChild(accordionEl);\r\n            }\r\n        }\r\n\r\n        // Create intent links element if any matched\r\n        if (!links.length) {\r\n            return;\r\n        }\r\n\r\n        const intentLinksEl = createIntentLinksElement(links);\r\n        if (!intentLinksEl) {\r\n            return;\r\n        }\r\n\r\n        // Store the matched links on the element for PDF export\r\n        botMessageEl._humataIntentLinks = links;\r\n\r\n        // Insert before the bot response disclaimer if present, otherwise append\r\n        const disclaimerEl = contentEl.querySelector('.humata-bot-response-disclaimer');\r\n        if (disclaimerEl) {\r\n            contentEl.insertBefore(intentLinksEl, disclaimerEl);\r\n        } else {\r\n            contentEl.appendChild(intentLinksEl);\r\n        }\r\n    }\r\n\r\n    // Track the last user message for intent link matching\r\n    let lastUserMessageForIntents = '';\r\n\r\n    /**\r\n     * Show loading indicator.\r\n     *\r\n     * @returns {HTMLElement} The loading element.\r\n     */\r\n    function showLoading() {\r\n        // Hide disclaimer while loading\r\n        hideBotResponseDisclaimer();\r\n\r\n        const loadingDiv = document.createElement('div');\r\n        loadingDiv.className = 'humata-message humata-message-bot humata-message-loading';\r\n        loadingDiv.id = 'humata-loading-indicator';\r\n\r\n        const avatarDiv = document.createElement('div');\r\n        avatarDiv.className = 'humata-message-avatar';\r\n        setAvatarContent(avatarDiv, 'bot');\r\n\r\n        const contentDiv = document.createElement('div');\r\n        contentDiv.className = 'humata-message-content';\r\n        const secondStageProvider = String(config.secondLlmProvider || '').toLowerCase();\r\n        const showStatus = secondStageProvider !== '' && secondStageProvider !== 'none';\r\n        if (showStatus) {\r\n            contentDiv.innerHTML = '' +\r\n                '<div class=\"humata-typing-indicator\"><span></span><span></span><span></span></div>' +\r\n                '<div class=\"humata-loading-status\" aria-live=\"polite\" aria-atomic=\"true\">' +\r\n                    '<span class=\"humata-loading-status-text\"></span>' +\r\n                '</div>';\r\n        } else {\r\n            contentDiv.innerHTML = '<div class=\"humata-typing-indicator\"><span></span><span></span><span></span></div>';\r\n        }\r\n\r\n        loadingDiv.appendChild(avatarDiv);\r\n        loadingDiv.appendChild(contentDiv);\r\n        elements.messages.appendChild(loadingDiv);\r\n\r\n        if (showStatus) {\r\n            const statusEl = contentDiv.querySelector('.humata-loading-status-text');\r\n            if (statusEl) {\r\n                const phrases = [\r\n                    'Processing your question\u2026',\r\n                    config.i18n?.thinking || 'Thinking\u2026',\r\n                    'Reviewing for accuracy\u2026',\r\n                    'Just a few moments more\u2026',\r\n                    'Almost ready\u2026',\r\n                    'Finalizing answer\u2026'\r\n                ];\r\n\r\n                let idx = 0;\r\n                statusEl.textContent = phrases[idx];\r\n                statusEl.style.opacity = '1';\r\n\r\n                loadingDiv._humataStatusTimer = setInterval(function() {\r\n                    idx = (idx + 1) % phrases.length;\r\n                    statusEl.style.opacity = '0';\r\n                    loadingDiv._humataStatusFadeTimer = setTimeout(function() {\r\n                        statusEl.textContent = phrases[idx];\r\n                        statusEl.style.opacity = '1';\r\n                    }, 180);\r\n                }, 2000);\r\n            }\r\n        }\r\n\r\n        scrollToBottom();\r\n\r\n        return loadingDiv;\r\n    }\r\n\r\n    /**\r\n     * Hide loading indicator.\r\n     */\r\n    function hideLoading() {\r\n        const loading = document.getElementById('humata-loading-indicator');\r\n        if (loading) {\r\n            if (loading._humataStatusTimer) {\r\n                clearInterval(loading._humataStatusTimer);\r\n            }\r\n            if (loading._humataStatusFadeTimer) {\r\n                clearTimeout(loading._humataStatusFadeTimer);\r\n            }\r\n            loading.remove();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Scroll chat to bottom.\r\n     */\r\n    function scrollToBottom() {\r\n        if (isEmbedded && elements.messages) {\r\n            elements.messages.scrollTop = elements.messages.scrollHeight;\r\n        } else {\r\n            window.scrollTo({\r\n                top: document.documentElement.scrollHeight,\r\n                behavior: 'smooth'\r\n            });\r\n        }\r\n        updateScrollToggleState();\r\n    }\r\n\r\n    /**\r\n     * Send message to API.\r\n     *\r\n     * @param {string} message - User message.\r\n     */\r\n    async function sendMessage(message, history = []) {\r\n        if (isLoading) return;\r\n\r\n        isLoading = true;\r\n\r\n        try {\r\n            // Check if Turnstile verification is needed (before showing loading)\r\n            let turnstileTokenForRequest = null;\r\n            if (isTurnstileEnabled() && !isTurnstileVerified()) {\r\n                try {\r\n                    turnstileTokenForRequest = await getTurnstileToken();\r\n                } catch (turnstileError) {\r\n                    console.error('Turnstile error:', turnstileError);\r\n                    isLoading = false;\r\n                    addMessage(config.i18n?.errorTurnstile || 'Human verification failed. Please try again.', 'bot', true);\r\n                    return;\r\n                }\r\n            }\r\n\r\n            // Show loading indicator after Turnstile verification\r\n            showLoading();\r\n\r\n            // Build request headers\r\n            const headers = {\r\n                'Content-Type': 'application/json',\r\n                'X-WP-Nonce': config.wpNonce,\r\n                'X-Humata-Nonce': config.nonce\r\n            };\r\n\r\n            // Include Turnstile token if we have one\r\n            if (turnstileTokenForRequest) {\r\n                headers['X-Turnstile-Token'] = turnstileTokenForRequest;\r\n            }\r\n\r\n            const response = await fetch(config.apiUrl, {\r\n                method: 'POST',\r\n                credentials: 'same-origin',\r\n                headers: headers,\r\n                body: JSON.stringify({\r\n                    message: message,\r\n                    history: history\r\n                })\r\n            });\r\n\r\n            hideLoading();\r\n\r\n            const data = await response.json();\r\n\r\n            if (!response.ok) {\r\n                const requestFailedMessage = config.i18n?.errorRequestFailed || 'Your message request failed. Try again. If problem persists, please contact us.';\r\n                let errorMessage = config.i18n?.errorGeneric || 'An error occurred. Please try again.';\r\n\r\n                if (response.status === 429) {\r\n                    errorMessage = config.i18n?.errorRateLimit || 'Too many requests. Please wait a moment.';\r\n                } else if (data && data.code === 'turnstile_required') {\r\n                    // Server requires Turnstile verification - clear local state and retry\r\n                    sessionStorage.removeItem(TURNSTILE_VERIFIED_KEY);\r\n                    turnstileToken = null;\r\n                    errorMessage = config.i18n?.errorTurnstileRequired || 'Please complete the human verification to continue.';\r\n                } else if (data && data.code === 'turnstile_failed') {\r\n                    // Turnstile verification failed\r\n                    sessionStorage.removeItem(TURNSTILE_VERIFIED_KEY);\r\n                    turnstileToken = null;\r\n                    errorMessage = config.i18n?.errorTurnstileFailed || 'Human verification failed. Please try again.';\r\n                } else if (data && typeof data.message === 'string' && data.message.trim() !== '') {\r\n                    const providerMentionPattern = /\\b(straico|humata|anthropic|claude)\\b/i;\r\n                    errorMessage = providerMentionPattern.test(data.message) ? requestFailedMessage : data.message;\r\n                } else {\r\n                    errorMessage = requestFailedMessage;\r\n                }\r\n\r\n                addMessage(errorMessage, 'bot', true);\r\n                return;\r\n            }\r\n\r\n            // Mark Turnstile as verified on successful response\r\n            if (isTurnstileEnabled() && turnstileTokenForRequest) {\r\n                setTurnstileVerified();\r\n            }\r\n\r\n            if (data.success && data.answer) {\r\n                const botMessageEl = addMessage(data.answer, 'bot');\r\n                // Append intent-based resource links if keywords matched\r\n                if (botMessageEl && lastUserMessageForIntents) {\r\n                    appendIntentLinksToMessage(botMessageEl, lastUserMessageForIntents);\r\n                    saveHistory(); // Re-save to include intent links\r\n                }\r\n            } else {\r\n                addMessage(config.i18n?.errorGeneric || 'An error occurred. Please try again.', 'bot', true);\r\n            }\r\n\r\n        } catch (error) {\r\n            hideLoading();\r\n            addMessage(config.i18n?.errorNetwork || 'Network error. Please check your connection.', 'bot', true);\r\n        } finally {\r\n            isLoading = false;\r\n            elements.input.focus();\r\n        }\r\n    }\r\n\r\n    function handleExportPdf() {\r\n        const exportButton = elements.exportPdfButton;\r\n        if (exportButton) {\r\n            exportButton.disabled = true;\r\n        }\r\n\r\n        try {\r\n            const jsPDF = (window.jspdf && window.jspdf.jsPDF) ? window.jspdf.jsPDF : (window.jsPDF || null);\r\n            if (!jsPDF) {\r\n                return;\r\n            }\r\n\r\n            const doc = new jsPDF({ unit: 'pt', format: 'a4' });\r\n\r\n            const pageWidth = doc.internal.pageSize.getWidth ? doc.internal.pageSize.getWidth() : doc.internal.pageSize.width;\r\n            const pageHeight = doc.internal.pageSize.getHeight ? doc.internal.pageSize.getHeight() : doc.internal.pageSize.height;\r\n\r\n            const marginX = 40;\r\n            const marginY = 40;\r\n            const maxWidth = pageWidth - (marginX * 2);\r\n            const lineHeight = 14;\r\n\r\n            let y = marginY;\r\n\r\n            const now = new Date();\r\n\r\n            function buildFilename() {\r\n                const yyyy = String(now.getFullYear());\r\n                const mm = String(now.getMonth() + 1).padStart(2, '0');\r\n                const dd = String(now.getDate()).padStart(2, '0');\r\n                let name = 'chat-export-' + yyyy + '-' + mm + '-' + dd;\r\n\r\n                if (conversationId) {\r\n                    const safeId = String(conversationId).replace(/[^\\w-]+/g, '').slice(0, 40);\r\n                    if (safeId) {\r\n                        name += '-' + safeId;\r\n                    }\r\n                }\r\n\r\n                return name + '.pdf';\r\n            }\r\n\r\n            function normalizePdfText(text) {\r\n                return String(text || '')\r\n                    .replace(/\\u00A0/g, ' ')\r\n                    .replace(/[\\u200B\\u200C\\u200D\\uFEFF]/g, '')\r\n                    .replace(/\\u2022/g, '-')\r\n                    .replace(/[\\u2018\\u2019]/g, \"'\")\r\n                    .replace(/[\\u201C\\u201D]/g, '\"')\r\n                    .replace(/[\\u2013\\u2014]/g, '-')\r\n                    .replace(/\\u2026/g, '...')\r\n                    .replace(/\\r\\n?/g, '\\n')\r\n                    .trim();\r\n            }\r\n\r\n            function docTextSafe(text, x, yPos) {\r\n                try {\r\n                    doc.text(text, x, yPos);\r\n                } catch (e) {\r\n                    doc.text(String(text || '').replace(/[^\\x09\\x0A\\x0D\\x20-\\x7E]/g, '?'), x, yPos);\r\n                }\r\n            }\r\n\r\n            const titleEl = document.querySelector('.humata-chat-title');\r\n            const title = ((titleEl ? titleEl.textContent : '') || 'Chat Export').trim();\r\n\r\n            doc.setFont('helvetica', 'bold');\r\n            doc.setFontSize(16);\r\n            docTextSafe(title || 'Chat Export', marginX, y);\r\n            y += 22;\r\n\r\n            doc.setFont('helvetica', 'normal');\r\n            doc.setFontSize(10);\r\n            docTextSafe(now.toLocaleString(), marginX, y);\r\n            y += 24;\r\n\r\n            const messageEls = elements.messages ? elements.messages.querySelectorAll('.humata-message:not(#humata-welcome-message):not(.humata-message-loading)') : [];\r\n            const messages = [];\r\n\r\n            messageEls.forEach(function(el) {\r\n                const contentEl = el.querySelector('.humata-message-content');\r\n                if (!contentEl) {\r\n                    return;\r\n                }\r\n\r\n                const isUser = el.classList.contains('humata-message-user');\r\n                const isError = el.classList.contains('humata-message-error');\r\n\r\n                let text = '';\r\n                if (isUser) {\r\n                    text = getMessagePlainText(contentEl);\r\n                } else {\r\n                    const html = getMessageHtmlForStorage(contentEl);\r\n                    text = htmlFragmentToPlainText(html);\r\n                }\r\n\r\n                text = normalizePdfText(text);\r\n                if (!text) {\r\n                    return;\r\n                }\r\n\r\n                // Collect intent links if present on bot messages\r\n                let intentLinks = null;\r\n                if (!isUser && !isError && el._humataIntentLinks && el._humataIntentLinks.length) {\r\n                    intentLinks = el._humataIntentLinks;\r\n                }\r\n\r\n                // Collect accordions if present on bot messages\r\n                let intentAccordions = null;\r\n                if (!isUser && !isError && el._humataIntentAccordions && el._humataIntentAccordions.length) {\r\n                    intentAccordions = el._humataIntentAccordions;\r\n                }\r\n\r\n                messages.push({\r\n                    role: isUser ? 'You' : 'Assistant',\r\n                    text: text,\r\n                    isError: isError,\r\n                    intentLinks: intentLinks,\r\n                    intentAccordions: intentAccordions\r\n                });\r\n            });\r\n\r\n            // Track seen accordion titles globally to avoid duplicates in PDF\r\n            const seenAccordionTitles = new Set();\r\n\r\n            if (!messages.length) {\r\n                doc.setFont('helvetica', 'normal');\r\n                doc.setFontSize(12);\r\n                docTextSafe('No messages.', marginX, y);\r\n                doc.save(buildFilename());\r\n                return;\r\n            }\r\n\r\n            messages.forEach(function(msg) {\r\n                doc.setFont('helvetica', 'bold');\r\n                doc.setFontSize(13);\r\n\r\n                const label = msg.role + (msg.isError ? ' (error)' : '') + ':';\r\n                if (y + lineHeight > pageHeight - marginY) {\r\n                    doc.addPage();\r\n                    y = marginY;\r\n                }\r\n                docTextSafe(label, marginX, y);\r\n                y += lineHeight;\r\n\r\n                doc.setFont('helvetica', 'normal');\r\n                doc.setFontSize(12);\r\n\r\n                const lines = doc.splitTextToSize(msg.text, maxWidth);\r\n                for (let i = 0; i < lines.length; i++) {\r\n                    if (y + lineHeight > pageHeight - marginY) {\r\n                        doc.addPage();\r\n                        y = marginY;\r\n                    }\r\n                    docTextSafe(lines[i], marginX, y);\r\n                    y += lineHeight;\r\n                }\r\n\r\n                // Render accordions if present (deduplicated globally)\r\n                if (msg.intentAccordions && msg.intentAccordions.length) {\r\n                    // Filter to only accordions we haven't seen yet\r\n                    const newAccordions = msg.intentAccordions.filter(function(acc) {\r\n                        if (seenAccordionTitles.has(acc.title)) {\r\n                            return false;\r\n                        }\r\n                        seenAccordionTitles.add(acc.title);\r\n                        return true;\r\n                    });\r\n\r\n                    if (newAccordions.length) {\r\n                        y += 4;\r\n\r\n                        for (let a = 0; a < newAccordions.length; a++) {\r\n                            const acc = newAccordions[a];\r\n\r\n                            // Accordion title (bold)\r\n                            doc.setFont('helvetica', 'bold');\r\n                            doc.setFontSize(11);\r\n                            if (y + lineHeight > pageHeight - marginY) {\r\n                                doc.addPage();\r\n                                y = marginY;\r\n                            }\r\n                            docTextSafe('\u25B8 ' + acc.title, marginX, y);\r\n                            y += lineHeight;\r\n\r\n                            // Accordion content (normal, indented)\r\n                            doc.setFont('helvetica', 'normal');\r\n                            doc.setFontSize(11);\r\n                            // Strip HTML tags and convert to plain text\r\n                            const plainContent = acc.content\r\n                                .replace(/<br\\s*\\/?>/gi, '\\n')\r\n                                .replace(/<\\/p>/gi, '\\n')\r\n                                .replace(/<[^>]+>/g, '')\r\n                                .replace(/&nbsp;/g, ' ')\r\n                                .replace(/&amp;/g, '&')\r\n                                .replace(/&lt;/g, '<')\r\n                                .replace(/&gt;/g, '>')\r\n                                .replace(/&quot;/g, '\"')\r\n                                .trim();\r\n                            const contentLines = doc.splitTextToSize(plainContent, maxWidth - 10);\r\n                            for (let c = 0; c < contentLines.length; c++) {\r\n                                if (y + lineHeight > pageHeight - marginY) {\r\n                                    doc.addPage();\r\n                                    y = marginY;\r\n                                }\r\n                                docTextSafe('  ' + contentLines[c], marginX, y);\r\n                                y += lineHeight;\r\n                            }\r\n                            y += 2;\r\n                        }\r\n                    }\r\n                }\r\n\r\n                // Render intent links if present\r\n                if (msg.intentLinks && msg.intentLinks.length) {\r\n                    y += 4;\r\n                    doc.setFont('helvetica', 'italic');\r\n                    doc.setFontSize(11);\r\n\r\n                    const resourceLabel = config.i18n?.relatedResources || 'Related resources:';\r\n                    if (y + lineHeight > pageHeight - marginY) {\r\n                        doc.addPage();\r\n                        y = marginY;\r\n                    }\r\n                    docTextSafe(resourceLabel, marginX, y);\r\n                    y += lineHeight;\r\n\r\n                    doc.setFont('helvetica', 'normal');\r\n                    for (let k = 0; k < msg.intentLinks.length; k++) {\r\n                        const link = msg.intentLinks[k];\r\n                        const linkText = '\u2022 ' + link.title + ' - ' + link.url;\r\n                        const linkLines = doc.splitTextToSize(linkText, maxWidth);\r\n                        for (let l = 0; l < linkLines.length; l++) {\r\n                            if (y + lineHeight > pageHeight - marginY) {\r\n                                doc.addPage();\r\n                                y = marginY;\r\n                            }\r\n                            docTextSafe(linkLines[l], marginX, y);\r\n                            y += lineHeight;\r\n                        }\r\n                    }\r\n                }\r\n\r\n                y += lineHeight;\r\n            });\r\n\r\n            doc.save(buildFilename());\r\n        } catch (e) {\r\n            console.error(e);\r\n        } finally {\r\n            if (exportButton) {\r\n                exportButton.disabled = false;\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Handle clear chat button click.\r\n     */\r\n    function handleClear() {\r\n        // Clear messages from DOM\r\n        if (elements.messages) {\r\n            elements.messages.innerHTML = '';\r\n        }\r\n\r\n        // Show welcome message again\r\n        if (elements.welcomeMessage) {\r\n            elements.welcomeMessage.style.display = '';\r\n            elements.messages.appendChild(elements.welcomeMessage);\r\n            ensureCopyButton(elements.welcomeMessage.querySelector('.humata-message-content'));\r\n        } else {\r\n            // Recreate welcome message if it doesn't exist\r\n            const welcomeDiv = document.createElement('div');\r\n            welcomeDiv.id = 'humata-welcome-message';\r\n            welcomeDiv.className = 'humata-message humata-message-bot';\r\n\r\n            const avatarDiv = document.createElement('div');\r\n            avatarDiv.className = 'humata-message-avatar';\r\n            setAvatarContent(avatarDiv, 'bot');\r\n\r\n            const contentDiv = document.createElement('div');\r\n            contentDiv.className = 'humata-message-content';\r\n            contentDiv.innerHTML = '<p>' + (config.i18n?.welcome || \"Hello! I'm here to help answer your questions. What would you like to know?\") + '</p>';\r\n\r\n            welcomeDiv.appendChild(avatarDiv);\r\n            welcomeDiv.appendChild(contentDiv);\r\n            elements.messages.appendChild(welcomeDiv);\r\n\r\n            elements.welcomeMessage = welcomeDiv;\r\n            ensureCopyButton(contentDiv);\r\n        }\r\n\r\n        // Clear localStorage\r\n        localStorage.removeItem(STORAGE_KEY);\r\n        localStorage.removeItem(CONVERSATION_KEY);\r\n        conversationId = null;\r\n\r\n        // Focus input\r\n        if (elements.input) {\r\n            elements.input.focus();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Save chat history to localStorage.\r\n     */\r\n    function saveHistory() {\r\n        if (!elements.messages) return;\r\n\r\n        const messages = [];\r\n        const messageElements = elements.messages.querySelectorAll('.humata-message:not(#humata-welcome-message):not(.humata-message-loading)');\r\n        let lastUserMessage = '';\r\n\r\n        messageElements.forEach(function(el) {\r\n            const isUser = el.classList.contains('humata-message-user');\r\n            const isError = el.classList.contains('humata-message-error');\r\n            const content = el.querySelector('.humata-message-content');\r\n\r\n            if (content) {\r\n                const msgData = {\r\n                    type: isUser ? 'user' : 'bot',\r\n                    content: isUser ? getMessagePlainText(content) : getMessageHtmlForStorage(content),\r\n                    isError: isError\r\n                };\r\n\r\n                if (isUser) {\r\n                    lastUserMessage = msgData.content;\r\n                } else {\r\n                    // Store the user message that triggered this bot response for intent links\r\n                    msgData.triggerUserMessage = lastUserMessage;\r\n                }\r\n\r\n                messages.push(msgData);\r\n            }\r\n        });\r\n\r\n        try {\r\n            localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));\r\n        } catch (e) {\r\n            // localStorage might be full or disabled\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Load chat history from localStorage.\r\n     */\r\n    function loadHistory() {\r\n        try {\r\n            const saved = localStorage.getItem(STORAGE_KEY);\r\n            if (!saved) return;\r\n\r\n            const messages = JSON.parse(saved);\r\n            if (!Array.isArray(messages) || messages.length === 0) return;\r\n\r\n            // Hide welcome message\r\n            if (elements.welcomeMessage) {\r\n                elements.welcomeMessage.style.display = 'none';\r\n            }\r\n\r\n            // Restore messages\r\n            messages.forEach(function(msg) {\r\n                const messageDiv = document.createElement('div');\r\n                messageDiv.className = 'humata-message humata-message-' + msg.type;\r\n\r\n                if (msg.isError) {\r\n                    messageDiv.classList.add('humata-message-error');\r\n                }\r\n\r\n                const avatarDiv = document.createElement('div');\r\n                avatarDiv.className = 'humata-message-avatar';\r\n                setAvatarContent(avatarDiv, msg.type);\r\n\r\n                const contentDiv = document.createElement('div');\r\n                contentDiv.className = 'humata-message-content';\r\n\r\n                // For bot messages, use innerHTML (already formatted)\r\n                // For user messages, use textContent\r\n                if (msg.type === 'user') {\r\n                    contentDiv.textContent = msg.content;\r\n                } else {\r\n                    contentDiv.innerHTML = msg.content;\r\n                }\r\n\r\n                ensureCopyButton(contentDiv);\r\n                if (msg.type === 'bot') {\r\n                    ensureRegenerateButton(contentDiv);\r\n                }\r\n                if (msg.type === 'user' && !msg.isError) {\r\n                    ensureEditButton(contentDiv);\r\n                }\r\n\r\n                messageDiv.appendChild(avatarDiv);\r\n                messageDiv.appendChild(contentDiv);\r\n                elements.messages.appendChild(messageDiv);\r\n\r\n                // Re-apply intent links for bot messages\r\n                if (msg.type === 'bot' && !msg.isError && msg.triggerUserMessage) {\r\n                    appendIntentLinksToMessage(messageDiv, msg.triggerUserMessage);\r\n                }\r\n            });\r\n\r\n            // Load conversation ID\r\n            conversationId = localStorage.getItem(CONVERSATION_KEY);\r\n\r\n            // Update bot response disclaimer position\r\n            updateBotResponseDisclaimerPosition();\r\n\r\n            // Scroll to bottom\r\n            scrollToBottom();\r\n\r\n        } catch (e) {\r\n            // Invalid JSON or other error\r\n            localStorage.removeItem(STORAGE_KEY);\r\n        }\r\n    }\r\n\r\n    // Initialize when DOM is ready\r\n    if (document.readyState === 'loading') {\r\n        document.addEventListener('DOMContentLoaded', init);\r\n    } else {\r\n        init();\r\n    }\r\n\r\n})();\r\n"],
  "mappings": "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",
  "names": ["config", "STORAGE_KEY", "CONVERSATION_KEY", "THEME_KEY", "TURNSTILE_VERIFIED_KEY", "DEFAULT_USER_AVATAR_SVG", "DEFAULT_BOT_AVATAR_SVG", "setAvatarContent", "avatarDiv", "type", "avatarUrl", "config", "img", "elements", "isLoading", "conversationId", "activeEdit", "maxPromptChars", "isEmbedded", "turnstileToken", "turnstileWidgetId", "turnstileReady", "turnstilePendingCallback", "init", "getMaxPromptChars", "initTheme", "initTurnstile", "ensureCopyButton", "loadHistory", "bindEvents", "handleInput", "updateScrollToggleState", "savedTheme", "THEME_KEY", "configTheme", "config", "theme", "applyTheme", "e", "html", "body", "toggleTheme", "newTheme", "isTurnstileEnabled", "isTurnstileVerified", "TURNSTILE_VERIFIED_KEY", "setTurnstileVerified", "loadTurnstileScript", "resolve", "reject", "script", "getTurnstileToken", "container", "widgetContainer", "token", "errorCode", "renderError", "error", "handleSend", "handleKeyDown", "handleScrollToggle", "handleMessagesClick", "handleClear", "handleExportPdf", "initTriggerPageModals", "trigger", "modalIndex", "modal", "openPageModal", "closeTarget", "closePageModal", "openModal", "pageModalLastFocused", "triggerEl", "closeBtn", "err", "fromConfig", "fromAttr", "updatePromptCounter", "current", "max", "event", "regenerateButton", "messageEl", "userMessageEl", "contentEl", "text", "getMessagePlainText", "history", "getChatHistoryForRequestBefore", "truncateConversationAfter", "saveHistory", "sendMessage", "copyButton", "payload", "getMessageClipboardPayload", "copyToClipboard", "indicateCopySuccess", "indicateCopyFailure", "editButton", "startEditMessage", "cancelActiveEdit", "saveActiveEdit", "setComposerEnabled", "enabled", "value", "_a", "_b", "_c", "_d", "originalText", "textarea", "actions", "cancelButton", "getXIconSvg", "saveButton", "getCheckIconSvg", "autoResizeEditTextarea", "maxHeight", "newHeight", "restoreUserMessageContent", "rawText", "newText", "errorMessage", "addMessage", "ensureEditButton", "hideLoading", "node", "next", "messageElements", "i", "el", "isUser", "content", "scrollHeight", "clientHeight", "scrollTop", "maxScrollable", "distanceFromBottom", "threshold", "shouldScrollToTop", "labelTop", "labelBottom", "label", "targetTop", "tooLong", "rawMessage", "message", "getChatHistoryForRequest", "lastUserMessageForIntents", "type", "isError", "messageDiv", "avatarDiv", "setAvatarContent", "contentDiv", "formatMessage", "ensureRegenerateButton", "updateBotResponseDisclaimerPosition", "scrollToBottom", "formatted", "escapeHtml", "codeBlocks", "match", "lang", "code", "safeLang", "sanitizeCodeLanguage", "renderMarkdownBlocks", "idx", "humataHtmlEntityDecoder", "decodeHtmlEntities", "sanitizeLinkHref", "href", "decoded", "cleaned", "schemeMatch", "scheme", "humataPreparedAutoLinks", "humataIsWordChar", "ch", "getPreparedAutoLinks", "raw", "prepared", "row", "phrase", "url", "safeHrefEscaped", "a", "b", "humataFindAutoLinkMatches", "rules", "haystack", "lower", "matches", "overlaps", "start", "end", "m", "r", "rule", "before", "after", "humataApplyAutoLinksToInlineHtml", "walker", "p", "name", "nodes", "textNode", "frag", "lastIndex", "isBlankLine", "line", "isCodeBlockTokenLine", "isHorizontalRuleLine", "parseHeadingLine", "isBlockquoteLine", "stripBlockquotePrefix", "isUnorderedListLine", "isOrderedListLine", "renderInlineMarkdown", "out", "codeSpans", "safeHref", "lines", "heading", "quoteLines", "items", "j", "itemText", "paraLines", "paraText", "div", "getOrCreateMessageActionsContainer", "actionsEl", "button", "getCopyIconSvg", "getRegenerateIconSvg", "getEditIconSvg", "editTextarea", "cloned", "btn", "getMessageHtmlForStorage", "innerHtml", "htmlFragmentToPlainText", "domNodeToPlainText", "ctx", "tag", "childrenText", "children", "ensureEndsWithNewline", "ensureBlankLine", "t", "block", "stack", "prefix", "indent", "copyPlainTextToClipboard", "item", "copyHtmlWithSelection", "selection", "savedRanges", "range", "successful", "copyPlainTextWithTextarea", "getBotResponseDisclaimerElement", "disclaimerHtml", "disclaimerEl", "botMessages", "hideBotResponseDisclaimer", "escapeRegexChars", "str", "findMatchingIntentLinks", "userMessage", "intents", "matchedLinks", "seenUrls", "intent", "keywords", "links", "matched", "k", "keyword", "link", "createIntentLinksElement", "pillsWrap", "findMatchingIntentAccordions", "matchedAccordions", "seenTitles", "accordions", "acc", "createAccordionElement", "toggle", "appendIntentLinksToMessage", "botMessageEl", "accordionEl", "intentLinksEl", "showLoading", "loadingDiv", "secondStageProvider", "showStatus", "statusEl", "phrases", "loading", "_e", "_f", "_g", "_h", "turnstileTokenForRequest", "turnstileError", "headers", "response", "data", "requestFailedMessage", "exportButton", "buildFilename", "yyyy", "now", "mm", "dd", "safeId", "normalizePdfText", "docTextSafe", "x", "yPos", "doc", "jsPDF", "pageWidth", "pageHeight", "marginX", "marginY", "maxWidth", "lineHeight", "y", "titleEl", "title", "messageEls", "messages", "intentLinks", "intentAccordions", "seenAccordionTitles", "msg", "newAccordions", "plainContent", "contentLines", "c", "resourceLabel", "linkText", "linkLines", "l", "welcomeDiv", "STORAGE_KEY", "CONVERSATION_KEY", "lastUserMessage", "msgData", "saved"]
}
